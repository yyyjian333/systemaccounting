<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>RM账单</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 品牌化外观 -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* —— 主题变量（来自你Logo的金色 + 深蓝） —— */
    :root{
      --bg: #fbf7ee;            /* 淡米色背景 */
      --surface: #ffffff;       /* 卡片底色 */
      --text: #1f2937;          /* 正文颜色 */
      --muted: #6b7280;         /* 次要文字 */
      --border: #e5e7eb;        /* 边框色 */

      --primary: #d4a016;       /* 品牌金色（主色） */
      --primary-600:#b4840e;    /* hover 深一点的金 */
      --primary-100:#fff4d1;    /* 浅金背景 */

      --info: #1f5fa3;          /* 品牌深蓝（操作色） */
      --info-600:#164a80;
      --info-100:#e8f2ff;

      --success:#16a34a;        /* 通过：绿 */
      --success-100:#e9f8ee;

      --warning:#f59e0b;        /* 审核中：黄 */
      --warning-100:#fff6db;

      --danger:#dc2626;         /* 拒绝：红 */
      --danger-100:#ffeaea;

      --radius: 12px;
      --radius-sm: 10px;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --shadow-sm: 0 3px 10px rgba(0,0,0,.05);
    }

    body{
      background:var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC","Microsoft Yahei","Noto Sans CJK SC", sans-serif;
      max-width:1100px; margin:28px auto; padding:0 16px;
    }
    h1{font-size:22px;margin:0 0 12px;font-weight:700}
    .nav{margin-bottom:14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .nav a{text-decoration:none}

    /* 卡片 */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
          padding:16px;box-shadow:var(--shadow)}

    /* 输入与筛选 */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .filters input,.filters select{
      padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:14px;background:#fff;
      outline:none; transition:.2s box-shadow;
    }
    .filters input:focus,.filters select:focus{box-shadow:0 0 0 4px rgba(212,160,22,.12)} /* 金色描边 */

    /* 漂亮按钮体系 */
    .btn{border:0;border-radius:var(--radius-sm);padding:9px 14px;font-size:14px;cursor:pointer;
         transition: transform .08s ease, box-shadow .2s ease, filter .2s ease; box-shadow:var(--shadow-sm)}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-600);filter:saturate(1.05)}
    .btn-info{background:var(--info);color:#fff}
    .btn-info:hover{background:var(--info-600)}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:#f3f4f6;color:#111}

    .who{font-size:12px;color:var(--muted);margin-left:8px}

    /* 表格：圆角卡片式 + 悬浮高亮 */
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    thead th{
      text-align:left;font-weight:600;font-size:13px;color:#374151;padding:8px 10px 6px 10px;
      border-bottom:1px solid var(--border);
    }
    tbody td{
      background:#fff;border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      padding:10px 10px;font-size:14px;
    }
    tbody tr{transition: box-shadow .2s ease, transform .08s ease}
    tbody tr:hover{box-shadow:var(--shadow-sm);transform:translateY(-1px)}
    tbody td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}

    /* 状态徽章（蓝/黄/绿/红） */
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid transparent;font-size:12px}
    .badge.blue{background:var(--info-100);color:var(--info-600);border-color:#c8d9f4}     /* 已提交 */
    .badge.yellow{background:var(--warning-100);color:#7a5b00;border-color:#ffe6a3}       /* 审核中 */
    .badge.green{background:var(--success-100);color:#136c3a;border-color:#c1f0d3}        /* 已完成 */
    .badge.red{background:var(--danger-100);color:#9a1414;border-color:#f5b6b6}          /* 拒绝 */

    /* 缩略图 */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{height:48px;width:auto;border-radius:8px;border:1px solid var(--border);object-fit:cover}
    .pdf{display:inline-block;padding:4px 6px;border:1px solid var(--border);border-radius:8px;text-decoration:none}

    /* 文本小样式 */
    .muted{color:var(--muted)}
    .empty{padding:24px;text-align:center;color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav">
    <a class="btn btn-primary" href="/submit.html">➕ 新增账单</a>
    <a class="btn btn-info" href="/dashboard.html">📊 Dashboard</a>
    <a class="btn btn-ghost" href="#" onclick="logout()">🚪 登出</a>
    <span id="who" class="who"></span>
  </div>

  <h1>🏦 RM账单</h1>

  <div class="card">
    <!-- 搜索 / 筛选 -->
    <div class="filters">
      <input id="kw" placeholder="搜索：姓名/用途/银行…" />
      <select id="st">
        <option value="">全部状态</option>
        <option value="已提交">已提交</option>
        <option value="审核中">审核中</option>
        <option value="已完成">已完成</option>
        <option value="拒绝">拒绝</option>
      </select>
      <button id="btnSearch" class="btn btn-info">搜索</button>
      <button id="btnClear" class="btn btn-ghost">清空</button>
    </div>

    <div id="status">正在从 Supabase 读取数据…</div>
    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>ID</th><th>提交人</th><th>金额</th><th>用途</th>
          <th>银行</th><th>账户</th><th>状态</th><th>创建时间</th><th>收据</th>
          <th id="thActions" style="display:none">操作</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">目前还没有数据，点左上角「新增账单」试试～</div>
  </div>

<script>
/* ===== Supabase 初始化：替换你的 URL / KEY ===== */
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false;
let currentUser = null;

/* ===== 自动建档：首次登录自动在 profiles 写入一行 ===== */
async function ensureProfile() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return null;
  const { data: prof } = await supabase.from('profiles').select('id').eq('id', user.id).maybeSingle();
  const name = user.user_metadata?.full_name || user.user_metadata?.name || (user.email ? user.email.split('@')[0] : '未命名用户');
  if (!prof) {
    await supabase.from('profiles').insert({ id: user.id, full_name: name, role: 'user' });
  } else {
    await supabase.from('profiles').update({ full_name: name }).eq('id', user.id).limit(1);
  }
  return user;
}

/* ===== 登录校验 + 角色判定 ===== */
async function checkLoginAndRole() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) { alert('请先登录'); location.href='/login.html'; return; }
  currentUser = session.user;
  document.getElementById('who').textContent = currentUser.email ?? '';
  await ensureProfile();

  const { data: prof } = await supabase
    .from('profiles')
    .select('role, full_name')
    .eq('id', currentUser.id)
    .maybeSingle();
  isAdmin = prof?.role === 'admin';
  if (isAdmin) document.getElementById('thActions').style.display = '';
}

/* ===== 读取列表 ===== */
function badgeClass(st){
  if(st==='已完成') return 'b-green';
  if(st==='审核中') return 'b-yellow';
  if(st==='拒绝') return 'b-red';
  return 'b-blue'; // 已提交
}
const esc = s => String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function renderThumb(url){
  if (/\.pdf(\?|$)/i.test(url)) return `<a class="pdf" href="${url}" target="_blank" rel="noopener">PDF</a>`;
  return `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="receipt"></a>`;
}

async function loadClaims({kw='',st=''}={}){
  const status=document.getElementById('status');
  const tbl=document.getElementById('tbl');
  const rows=document.getElementById('rows');
  const empty=document.getElementById('empty');

  status.style.display=''; tbl.style.display='none'; empty.style.display='none';
  status.textContent='正在加载…';

  let q = supabase.from('claims').select('id,submitter_name,amount,purpose,bank_name,account_no,status,created_at').order('created_at',{ascending:false});
  if (kw) {
    const k = kw.replace(/,/g,'');
    q = q.or(`submitter_name.ilike.%${k}%,purpose.ilike.%${k}%,bank_name.ilike.%${k}%`);
  }
  if (st) q = q.eq('status', st);

  const { data: claims, error } = await q;
  if (error){ console.error(error); alert('读取数据失败：'+error.message); return; }

  if (!claims || !claims.length){ status.style.display='none'; empty.style.display=''; rows.innerHTML=''; return; }

  const ids = claims.map(c=>c.id);
  const { data: atts } = await supabase.from('attachments').select('claim_id,file_url,type').in('claim_id', ids);
  const map=new Map(); (atts||[]).forEach(a=>{ if(!map.has(a.claim_id)) map.set(a.claim_id,[]); map.get(a.claim_id).push(a); });

  status.style.display='none'; tbl.style.display='';

  rows.innerHTML = claims.map(c=>{
    const list = map.get(c.id)||[];
    const thumbs = list.length ? `<div class="thumbs">${list.slice(0,4).map(a=>renderThumb(a.file_url)).join('')}</div>` : '<span class="muted">无</span>';
    let actions='';
    if (isAdmin){
      if (c.status==='已提交'){
        actions = `<button class="btn" onclick="setStatus(${c.id},'审核中')">设为审核中</button>`;
      }else if (c.status==='审核中'){
        actions = `<button class="btn" onclick="setStatus(${c.id},'已完成')">设为已完成</button>
                   <button class="btn" onclick="setStatus(${c.id},'已提交')" style="margin-left:6px">退回已提交</button>
                   <button class="btn" onclick="setStatus(${c.id},'拒绝')" style="margin-left:6px">拒绝</button>`;
      }
    }
    return `<tr>
      <td>${c.id}</td>
      <td>${esc(c.submitter_name)}</td>
      <td>${Number(c.amount).toFixed(2)}</td>
      <td>${esc(c.purpose)}</td>
      <td>${esc(c.bank_name)}</td>
      <td>${esc(c.account_no)}</td>
      <td><span class="badge ${badgeClass(c.status)}">${esc(c.status)}</span></td>
      <td>${new Date(c.created_at).toLocaleString()}</td>
      <td>${thumbs}</td>
      <td>${actions}</td>
    </tr>`;
  }).join('');
}

async function setStatus(id, next){
  const payload={status:next};
  if (next==='审核中') payload.reviewed_at=new Date().toISOString();
  if (next==='已完成')  payload.completed_at=new Date().toISOString();
  const { error } = await supabase.from('claims').update(payload).eq('id', id);
  if (error){ alert('更新失败：'+error.message); return; }
  loadClaims({kw:document.getElementById('kw').value.trim(), st:document.getElementById('st').value});
}

async function logout(){ await supabase.auth.signOut(); location.href='/login.html'; }

/* ===== 搜索事件 ===== */
document.getElementById('btnSearch').addEventListener('click', ()=>{
  loadClaims({kw:document.getElementById('kw').value.trim(), st:document.getElementById('st').value});
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('kw').value=''; document.getElementById('st').value='';
  loadClaims({});
});

/* ===== 新增进账（保留、极简） ===== */
function openIncomeModal(){ document.getElementById('incomeModal').style.display='flex'; document.getElementById('inDate').value = new Date().toISOString().slice(0,10); document.getElementById('incomeMsg').textContent=''; }
function closeIncomeModal(){ document.getElementById('incomeModal').style.display='none'; }
async function saveIncome(){
  const amount=parseFloat(document.getElementById('inAmount').value);
  const note=document.getElementById('inNote').value.trim();
  const date=document.getElementById('inDate').value;
  const msg=document.getElementById('incomeMsg');
  if(!amount){ msg.textContent='请填写金额'; return; }
  const { error } = await supabase.from('transactions').insert({ kind:'in', amount, note, occurred_at: date? new Date(date): new Date() });
  if (error){ msg.textContent='保存失败：'+error.message; return; }
  msg.textContent='保存成功'; setTimeout(()=>{ closeIncomeModal(); }, 600);
}

/* ===== 初始化 ===== */
(async function init(){
  await checkLoginAndRole();
  await loadClaims();
})();
</script>
</body>
</html>
