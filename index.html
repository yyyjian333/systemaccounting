<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>RMè´¦å•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--card:#fafafa;--bd:#eee;--txt:#222;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1100px;margin:28px auto;padding:0 16px;color:var(--txt)}
    h1{font-size:20px;margin:0 0 12px}
    .nav{margin-bottom:12px}
    .nav a{margin-right:12px}
    .card{border:1px solid var(--bd);border-radius:12px;padding:16px;background:var(--card)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--bd);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th{font-weight:600}
    .muted{color:var(--muted)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{height:48px;width:auto;border-radius:6px;border:1px solid var(--bd);object-fit:cover}
    .empty{padding:24px;text-align:center;color:var(--muted)}
    .pdf{display:inline-block;padding:4px 6px;border:1px solid var(--bd);border-radius:6px;text-decoration:none}
    /* å½©è‰²çŠ¶æ€å¾½ç«  */
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid transparent}
    .badge.blue{background:#e8f1ff;color:#154b9a;border-color:#cddffb}         /* å·²æäº¤ */
    .badge.yellow{background:#fff6db;color:#7a5b00;border-color:#ffecb0}       /* å®¡æ ¸ä¸­ */
    .badge.green{background:#e9f8ee;color:#136c3a;border-color:#c1f0d3}        /* å·²å®Œæˆ */
    /* é¡¶éƒ¨ç­›é€‰æ¡ */
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
    .filters input,.filters select{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    .filters button{padding:8px 12px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    .filters .ghost{background:#f2f2f2;color:#333}
    /* æ“ä½œæŒ‰é’® */
    .btn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer;font-size:12px}
    .btn.gray{background:#f2f2f2}
    .btn.blue{background:#0ea5e9;color:#fff}
    .btn.green{background:#16a34a;color:#fff}
    .who{font-size:12px;color:#666;margin-left:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav">
    <a href="/submit.html">â• æ–°å¢è´¦å•</a>
    <a href="/dashboard.html">ğŸ“Š Dashboard</a>
    <a href="#" onclick="logout()">ğŸšª ç™»å‡º</a>
    <span id="who" class="who"></span>
  </div>

  <h1>ğŸ¦ RMè´¦å•</h1>

  <div class="card">
    <!-- æœç´¢ / ç­›é€‰ -->
    <div class="filters">
      <input id="kw" placeholder="æœç´¢ï¼šå§“å/ç”¨é€”/é“¶è¡Œâ€¦" />
      <select id="st">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        <option value="å·²æäº¤">å·²æäº¤</option>
        <option value="å®¡æ ¸ä¸­">å®¡æ ¸ä¸­</option>
        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
      </select>
      <button id="btnSearch">æœç´¢</button>
      <button id="btnClear" class="ghost">æ¸…ç©º</button>
    </div>

    <div id="status">æ­£åœ¨ä» Supabase è¯»å–æ•°æ®â€¦</div>
    <table id="tbl" style="display:none">
      <thead>
      <tr>
        <th>ID</th>
        <th>æäº¤äºº</th>
        <th>é‡‘é¢</th>
        <th>ç”¨é€”</th>
        <th>é“¶è¡Œ</th>
        <th>è´¦æˆ·</th>
        <th>çŠ¶æ€</th>
        <th>åˆ›å»ºæ—¶é—´</th>
        <th>æ”¶æ®</th>
        <th id="thActions" style="display:none">æ“ä½œ</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">ç›®å‰è¿˜æ²¡æœ‰æ•°æ®ï¼Œç‚¹å·¦ä¸Šè§’ã€Œæ–°å¢è´¦å•ã€è¯•è¯•ï½</div>
  </div>

  <script>
    // ğŸ”§ æ›¿æ¢ä¸ºä½ çš„é¡¹ç›®é…ç½®
    const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ç™»å½•æ ¡éªŒ & è¯»å–è§’è‰²
    let isAdmin = false;
    let currentUser = null;

    async function checkLoginAndRole() {
      // æœªç™»å½• -> è·³è½¬
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert("è¯·å…ˆç™»å½•ï¼");
        window.location.href = "/login.html";
        return;
      }
      currentUser = session.user;
      document.getElementById('who').textContent = currentUser.email;

      // æŸ¥ profiles.role
      const { data: prof } = await supabase
        .from('profiles')
        .select('role, full_name')
        .eq('id', currentUser.id)
        .maybeSingle();

      isAdmin = prof?.role === 'admin';
      if (isAdmin) document.getElementById('thActions').style.display = '';
    }

    async function logout(){
      await supabase.auth.signOut();
      window.location.href = "/login.html";
    }

    const statusClass = (s) => s === 'å·²å®Œæˆ' ? 'green' : (s === 'å®¡æ ¸ä¸­' ? 'yellow' : 'blue');
    const esc = s => String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // åŠ è½½æ•°æ®ï¼ˆä¸¤æ­¥æŸ¥ï¼šclaims + attachmentsï¼‰
    async function loadClaims({ kw = '', st = '' } = {}){
      const status = document.getElementById('status');
      const table  = document.getElementById('tbl');
      const tbody  = document.getElementById('rows');
      const empty  = document.getElementById('empty');

      status.textContent = "æ­£åœ¨åŠ è½½â€¦";
      table.style.display = 'none';
      empty.style.display = 'none';

      let q = supabase
        .from('claims')
        .select('id, submitter_name, amount, purpose, bank_name, account_no, status, created_at, reviewed_at, completed_at')
        .order('created_at', { ascending: false });

      if (kw) {
        const k = kw.replace(/,/g,'');
        q = q.or(`submitter_name.ilike.%${k}%,purpose.ilike.%${k}%,bank_name.ilike.%${k}%`);
      }
      if (st) q = q.eq('status', st);

      const { data: claims, error: e1 } = await q;
      if (e1) { status.textContent = "è¯»å–å¤±è´¥ï¼š" + e1.message; console.error(e1); return; }
      if (!claims || !claims.length) { status.style.display = 'none'; empty.style.display = ''; return; }

      const ids = claims.map(c => c.id);
      const { data: atts, error: e2 } = await supabase
        .from('attachments')
        .select('claim_id, file_url, type')
        .in('claim_id', ids);
      if (e2) console.error(e2);

      const map = new Map();
      (atts||[]).forEach(a => { if (!map.has(a.claim_id)) map.set(a.claim_id, []); map.get(a.claim_id).push(a); });

      status.style.display = 'none';
      table.style.display  = '';

      tbody.innerHTML = claims.map(c => {
        const list = map.get(c.id) || [];
        const thumbs = list.length
          ? `<div class="thumbs">
               ${list.slice(0,3).map(a => renderThumb(a.file_url)).join('')}
               ${list.length > 3 ? `<span class="muted">+${list.length-3} æ›´å¤šâ€¦</span>` : ''}
             </div>`
          : `<span class="muted">æ— </span>`;

        // ç®¡ç†å‘˜æ“ä½œæŒ‰é’®
        let actions = '';
        if (isAdmin) {
          if (c.status === 'å·²æäº¤') {
            actions = `<button class="btn blue" onclick="setStatus(${c.id}, 'å®¡æ ¸ä¸­')">è®¾ä¸ºå®¡æ ¸ä¸­</button>`;
          } else if (c.status === 'å®¡æ ¸ä¸­') {
            actions = `<button class="btn green" onclick="setStatus(${c.id}, 'å·²å®Œæˆ')">è®¾ä¸ºå·²å®Œæˆ</button>
                       <button class="btn gray" style="margin-left:6px" onclick="setStatus(${c.id}, 'å·²æäº¤')">é€€å›å·²æäº¤</button>`;
          }
        }

        return `
          <tr>
            <td>${c.id}</td>
            <td>${esc(c.submitter_name)}</td>
            <td>${Number(c.amount).toFixed(2)}</td>
            <td>${esc(c.purpose)}</td>
            <td>${esc(c.bank_name)}</td>
            <td>${esc(c.account_no)}</td>
            <td><span class="badge ${statusClass(c.status)}">${esc(c.status)}</span></td>
            <td>${new Date(c.created_at).toLocaleString()}</td>
            <td>${thumbs}</td>
            <td>${actions}</td>
          </tr>`;
      }).join('');
    }

    function renderThumb(url){
      const isPdf = /\.pdf(\?|$)/i.test(url);
      if (isPdf) return `<a class="pdf" href="${url}" target="_blank" rel="noopener">PDF</a>`;
      return `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="receipt" /></a>`;
    }

    // å®¡æ‰¹ï¼šæ›´æ–°çŠ¶æ€ï¼ˆåªæœ‰ admin æœ‰ç­–ç•¥æƒé™ï¼‰
    async function setStatus(id, next){
      const payload = { status: next };
      if (next === 'å®¡æ ¸ä¸­') payload.reviewed_at = new Date().toISOString();
      if (next === 'å·²å®Œæˆ')  payload.completed_at = new Date().toISOString();

      const { error } = await supabase.from('claims').update(payload).eq('id', id);
      if (error) { alert('æ›´æ–°å¤±è´¥ï¼š' + error.message); console.error(error); return; }
      loadClaims({ kw: document.getElementById('kw').value.trim(), st: document.getElementById('st').value });
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('btnSearch').addEventListener('click', () => {
      loadClaims({ kw: document.getElementById('kw').value.trim(), st: document.getElementById('st').value });
    });
    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('kw').value = '';
      document.getElementById('st').value = '';
      loadClaims({});
    });

    // é¡µé¢åˆå§‹åŒ–
    (async function init(){
      await checkLoginAndRole();
      await loadClaims();
    })();
  </script>
</body>
</html>
