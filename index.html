<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>RMè´¦å•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- å“ç‰ŒåŒ–å¤–è§‚ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* â€”â€” ä¸»é¢˜å˜é‡ï¼ˆå“ç‰Œé‡‘è‰² + æ·±è“ï¼‰ â€”â€” */
    :root{
      --bg: #fbf7ee;           /* æ·¡ç±³è‰²èƒŒæ™¯ */
      --surface: #ffffff;      /* å¡ç‰‡åº•è‰² */
      --text: #1f2937;         /* æ­£æ–‡é¢œè‰² */
      --muted: #6b7280;        /* æ¬¡è¦æ–‡å­— */
      --border: #e5e7eb;       /* è¾¹æ¡†è‰² */

      --primary: #d4a016;      /* å“ç‰Œé‡‘è‰²ï¼ˆä¸»è‰²ï¼‰ */
      --primary-600:#b4840e;
      --primary-100:#fff4d1;

      --info: #1f5fa3;         /* å“ç‰Œæ·±è“ï¼ˆæ“ä½œè‰²ï¼‰ */
      --info-600:#164a80;
      --info-100:#e8f2ff;

      --success:#16a34a;       /* é€šè¿‡ï¼šç»¿ */
      --success-100:#e9f8ee;

      --warning:#f59e0b;       /* å®¡æ ¸ä¸­ï¼šé»„ */
      --warning-100:#fff6db;

      --danger:#dc2626;        /* æ‹’ç»ï¼šçº¢ */
      --danger-100:#ffeaea;

      --radius: 12px;
      --radius-sm: 10px;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --shadow-sm: 0 3px 10px rgba(0,0,0,.05);
    }

    body{
      background:var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC","Microsoft Yahei","Noto Sans CJK SC", sans-serif;
      max-width:1100px; margin:28px auto; padding:0 16px;
    }
    h1{font-size:22px;margin:0 0 12px;font-weight:700}
    .nav{margin-bottom:14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .nav a{text-decoration:none}

    /* å¡ç‰‡ */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
          padding:16px;box-shadow:var(--shadow)}

    /* è¾“å…¥ä¸ç­›é€‰ */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .filters input,.filters select{
      padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:14px;background:#fff;
      outline:none; transition:.2s box-shadow;
    }
    .filters input:focus,.filters select:focus{box-shadow:0 0 0 4px rgba(212,160,22,.12)} /* é‡‘è‰²æè¾¹ */

    /* æ¼‚äº®æŒ‰é’®ä½“ç³» */
    .btn{border:0;border-radius:var(--radius-sm);padding:9px 14px;font-size:14px;cursor:pointer;
         transition: transform .08s ease, box-shadow .2s ease, filter .2s ease; box-shadow:var(--shadow-sm)}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-600);filter:saturate(1.05)}
    .btn-info{background:var(--info);color:#fff}
    .btn-info:hover{background:var(--info-600)}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:#f3f4f6;color:#111}

    .who{font-size:12px;color:var(--muted);margin-left:8px}

    /* è¡¨æ ¼ï¼šåœ†è§’å¡ç‰‡å¼ + æ‚¬æµ®é«˜äº® */
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    thead th{
      text-align:left;font-weight:600;font-size:13px;color:#374151;padding:8px 10px 6px 10px;
      border-bottom:1px solid var(--border);
    }
    tbody td{
      background:#fff;border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      padding:10px 10px;font-size:14px;
    }
    tbody tr{transition: box-shadow .2s ease, transform .08s ease}
    tbody tr:hover{box-shadow:var(--shadow-sm);transform:translateY(-1px)}
    tbody td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}

    /* çŠ¶æ€å¾½ç« ï¼ˆè“/é»„/ç»¿/çº¢ï¼‰ */
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid transparent;font-size:12px}
    .badge.blue{background:var(--info-100);color:var(--info-600);border-color:#c8d9f4}     /* å·²æäº¤ */
    .badge.yellow{background:var(--warning-100);color:#7a5b00;border-color:#ffe6a3}       /* å®¡æ ¸ä¸­ */
    .badge.green{background:var(--success-100);color:#136c3a;border-color:#c1f0d3}        /* å·²å®Œæˆ */
    .badge.red{background:var(--danger-100);color:#9a1414;border-color:#f5b6b6}          /* æ‹’ç» */

    /* ç¼©ç•¥å›¾ */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{height:48px;width:auto;border-radius:8px;border:1px solid var(--border);object-fit:cover}
    .pdf{display:inline-block;padding:4px 6px;border:1px solid var(--border);border-radius:8px;text-decoration:none}

    /* æ–‡æœ¬å°æ ·å¼ */
    .muted{color:var(--muted)}
    .empty{padding:24px;text-align:center;color:var(--muted)}

    /* ===== æ–°å¢è¿›è´¦å¼¹çª—æ ·å¼ ===== */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none;
           align-items:center; justify-content:center; z-index:1000;}
    .modal-content{background:#fff; padding:22px 24px; border-radius:12px; width:100%; max-width:380px;
                   box-shadow:0 12px 28px rgba(0,0,0,.15)}
    .modal-content h3{margin:0 0 10px}
    .modal-content label{display:block; font-size:13px; color:#374151; margin:10px 0 6px}
    .modal-content input{width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px}
    .modal-content input:focus{outline:none; box-shadow:0 0 0 4px rgba(212,160,22,.12)}
    .modal-actions{display:flex; gap:10px; margin-top:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav">
    <a class="btn btn-primary" href="/submit.html">â• æ–°å¢è´¦å•</a>
    <button class="btn btn-info" onclick="openIncomeModal()">â• æ–°å¢è¿›è´¦</button>
    <a class="btn btn-info" href="/dashboard.html">ğŸ“Š Dashboard</a>
    <a class="btn btn-ghost" href="#" onclick="logout()">ğŸšª ç™»å‡º</a>
    <span id="who" class="who"></span>
  </div>

  <h1>ğŸ¦ RMè´¦å•</h1>

  <div class="card">
    <!-- æœç´¢ / ç­›é€‰ -->
    <div class="filters">
      <input id="kw" placeholder="æœç´¢ï¼šå§“å/ç”¨é€”/é“¶è¡Œâ€¦" />
      <select id="st">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        <option value="å·²æäº¤">å·²æäº¤</option>
        <option value="å®¡æ ¸ä¸­">å®¡æ ¸ä¸­</option>
        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
        <option value="æ‹’ç»">æ‹’ç»</option>
      </select>
      <button id="btnSearch" class="btn btn-info">æœç´¢</button>
      <button id="btnClear" class="btn btn-ghost">æ¸…ç©º</button>
    </div>

    <div id="status">æ­£åœ¨ä» Supabase è¯»å–æ•°æ®â€¦</div>
    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>ID</th><th>æäº¤äºº</th><th>é‡‘é¢</th><th>ç”¨é€”</th>
          <th>é“¶è¡Œ</th><th>è´¦æˆ·</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ”¶æ®</th>
          <th id="thActions" style="display:none">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">ç›®å‰è¿˜æ²¡æœ‰æ•°æ®ï¼Œç‚¹å·¦ä¸Šè§’ã€Œæ–°å¢è´¦å•ã€è¯•è¯•ï½</div>
  </div>

  <!-- ===== æ–°å¢è¿›è´¦å¼¹çª— ===== -->
  <div id="incomeModal" class="modal">
    <div class="modal-content">
      <h3>æ–°å¢è¿›è´¦</h3>
      <label>é‡‘é¢ï¼ˆMYRï¼‰*</label>
      <input id="inAmount" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š1000.00" />
      <label>å¤‡æ³¨</label>
      <input id="inNote" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ·è½¬è´¦ / é”€å”®å›æ¬¾" />
      <label>æ—¥æœŸ</label>
      <input id="inDate" type="date" />
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="saveIncome()">ä¿å­˜</button>
        <button class="btn btn-ghost" onclick="closeIncomeModal()">å–æ¶ˆ</button>
      </div>
      <p id="incomeMsg" class="muted" style="margin-top:8px"></p>
    </div>
  </div>

<script>
/* ============ Supabase åˆå§‹åŒ– ============ */
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
<script>
async function ensureProfile() {
  const { data: { user }, error: errUser } = await supabase.auth.getUser();
  if (errUser) throw errUser;
  if (!user) return null;

  const { data: prof } = await supabase
    .from('profiles')
    .select('id')
    .eq('id', user.id)
    .maybeSingle();

  const fullName =
    user.user_metadata?.full_name ||
    user.user_metadata?.name ||
    (user.email ? user.email.split('@')[0] : 'æœªå‘½åç”¨æˆ·');

  if (!prof) {
    const { error: insErr } = await supabase
      .from('profiles')
      .insert({ id: user.id, full_name: fullName, role: 'user' });
    if (insErr && insErr.code !== '23505') {
      console.error('åˆ›å»º profile å¤±è´¥:', insErr);
    }
  } else {
    await supabase.from('profiles')
      .update({ full_name: fullName })
      .eq('id', user.id)
      .limit(1);
  }
  return user;
}
</script>
  
let isAdmin = false;
let currentUser = null;

/* ç™»å½•æ ¡éªŒ + è¯»å–è§’è‰² */
async function checkLoginAndRole() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    alert("è¯·å…ˆç™»å½•ï¼");
    window.location.href = "/login.html";
    return;
  }
  currentUser = session.user;
  document.getElementById('who').textContent = currentUser.email;

  const { data: prof } = await supabase
    .from('profiles')
    .select('role, full_name')
    .eq('id', currentUser.id)
    .maybeSingle();

  isAdmin = prof?.role === 'admin';
  if (isAdmin) document.getElementById('thActions').style.display = '';
}

async function logout(){
  await supabase.auth.signOut();
  window.location.href = "/login.html";
}

/* çŠ¶æ€å¾½ç« é¢œè‰² */
const statusClass = (s) =>
  s === 'å·²å®Œæˆ' ? 'green' :
  s === 'å®¡æ ¸ä¸­' ? 'yellow' :
  s === 'æ‹’ç»' ? 'red' :
  'blue';

const esc = s => String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* è¯»å–è´¦å•ï¼ˆclaims + attachments ä¸¤æ­¥ï¼‰ */
async function loadClaims({ kw = '', st = '' } = {}){
  const status = document.getElementById('status');
  const table  = document.getElementById('tbl');
  const tbody  = document.getElementById('rows');
  const empty  = document.getElementById('empty');

  status.textContent = "æ­£åœ¨åŠ è½½â€¦";
  table.style.display = 'none';
  empty.style.display = 'none';

  let q = supabase.from('claims')
    .select('id, submitter_name, amount, purpose, bank_name, account_no, status, created_at, reviewed_at, completed_at')
    .order('created_at', { ascending: false });

  if (kw) {
    const k = kw.replace(/,/g,'');
    q = q.or(`submitter_name.ilike.%${k}%,purpose.ilike.%${k}%,bank_name.ilike.%${k}%`);
  }
  if (st) q = q.eq('status', st);

  const { data: claims, error: e1 } = await q;
  if (e1) { status.textContent = "è¯»å–å¤±è´¥ï¼š" + e1.message; console.error(e1); return; }
  if (!claims || !claims.length) { status.style.display = 'none'; empty.style.display = ''; return; }

  const ids = claims.map(c => c.id);
  const { data: atts, error: e2 } = await supabase.from('attachments')
    .select('claim_id, file_url, type')
    .in('claim_id', ids);
  if (e2) console.error(e2);

  const map = new Map();
  (atts||[]).forEach(a => { if (!map.has(a.claim_id)) map.set(a.claim_id, []); map.get(a.claim_id).push(a); });

  status.style.display = 'none';
  table.style.display  = '';

  tbody.innerHTML = claims.map(c => {
    const list = map.get(c.id) || [];
    const thumbs = list.length
      ? `<div class="thumbs">${list.slice(0,3).map(a=>renderThumb(a.file_url)).join('')}
         ${list.length>3?`<span class="muted">+${list.length-3} æ›´å¤šâ€¦</span>`:''}</div>`
      : `<span class="muted">æ— </span>`;

    // ç®¡ç†å‘˜æ“ä½œæŒ‰é’®
    let actions = '';
    if (isAdmin) {
      if (c.status === 'å·²æäº¤') {
        actions = `<button class="btn btn-info"    onclick="setStatus(${c.id}, 'å®¡æ ¸ä¸­')">è®¾ä¸ºå®¡æ ¸ä¸­</button>`;
      } else if (c.status === 'å®¡æ ¸ä¸­') {
        actions = `<button class="btn btn-success" onclick="setStatus(${c.id}, 'å·²å®Œæˆ')">è®¾ä¸ºå·²å®Œæˆ</button>
                   <button class="btn btn-ghost"   style="margin-left:6px" onclick="setStatus(${c.id}, 'å·²æäº¤')">é€€å›å·²æäº¤</button>
                   <button class="btn btn-danger"  style="margin-left:6px" onclick="setStatus(${c.id}, 'æ‹’ç»')">æ‹’ç»</button>`;
      }
    }

    return `<tr>
      <td>${c.id}</td>
      <td>${esc(c.submitter_name)}</td>
      <td>${Number(c.amount).toFixed(2)}</td>
      <td>${esc(c.purpose)}</td>
      <td>${esc(c.bank_name)}</td>
      <td>${esc(c.account_no)}</td>
      <td><span class="badge ${statusClass(c.status)}">${esc(c.status)}</span></td>
      <td>${new Date(c.created_at).toLocaleString()}</td>
      <td>${thumbs}</td>
      <td>${actions}</td>
    </tr>`;
  }).join('');
}

function renderThumb(url){
  const isPdf = /\.pdf(\?|$)/i.test(url);
  if (isPdf) return `<a class="pdf" href="${url}" target="_blank" rel="noopener">PDF</a>`;
  return `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="receipt" /></a>`;
}

/* å®¡æ‰¹çŠ¶æ€æ›´æ–°ï¼ˆadmin æƒé™ï¼‰ */
async function setStatus(id, next){
  const payload = { status: next };
  if (next === 'å®¡æ ¸ä¸­') payload.reviewed_at = new Date().toISOString();
  if (next === 'å·²å®Œæˆ')  payload.completed_at = new Date().toISOString();

  const { error } = await supabase.from('claims').update(payload).eq('id', id);
  if (error) { alert('æ›´æ–°å¤±è´¥ï¼š' + error.message); console.error(error); return; }
  loadClaims({ kw: document.getElementById('kw').value.trim(), st: document.getElementById('st').value });
}

/* ===== æ–°å¢è¿›è´¦ï¼šæ‰“å¼€/å…³é—­/ä¿å­˜ ===== */
function openIncomeModal(){
  document.getElementById('incomeModal').style.display = 'flex';
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('inDate').value = today;
  document.getElementById('incomeMsg').textContent = '';
  document.getElementById('inAmount').value = '';
  document.getElementById('inNote').value = '';
}
function closeIncomeModal(){
  document.getElementById('incomeModal').style.display = 'none';
}
async function saveIncome(){
  const amount = parseFloat(document.getElementById('inAmount').value);
  const note = document.getElementById('inNote').value.trim();
  const date = document.getElementById('inDate').value;
  const msg = document.getElementById('incomeMsg');
  if(!amount){ msg.textContent="è¯·å¡«å†™é‡‘é¢"; return; }

  const { error } = await supabase.from('transactions')
    .insert({ kind:'in', amount, note, occurred_at: date ? new Date(date) : new Date() });

  if(error){ msg.textContent="ä¿å­˜å¤±è´¥ï¼š"+error.message; console.error(error); return; }

  msg.textContent="âœ… ä¿å­˜æˆåŠŸï¼";
  setTimeout(()=>{ closeIncomeModal(); }, 700);
}

/* äº‹ä»¶ç»‘å®š */
document.getElementById('btnSearch').addEventListener('click', () => {
  loadClaims({ kw: document.getElementById('kw').value.trim(), st: document.getElementById('st').value });
});
document.getElementById('btnClear').addEventListener('click', () => {
  document.getElementById('kw').value = '';
  document.getElementById('st').value = '';
  loadClaims({});
});

/* é¡µé¢åˆå§‹åŒ– */
(async function init(){
  await checkLoginAndRole();
  await loadClaims();
})();
</script>
</body>
</html>
