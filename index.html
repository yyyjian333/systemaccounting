<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RM 账单系统</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background-color: #fdf8f3;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h2 {
      color: #004b91;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #004b91;
      color: #fff;
    }

    tr:hover {
      background-color: #f9f9f9;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-blue {
      background-color: #004b91;
      color: white;
    }

    .btn-blue:hover {
      background-color: #00366d;
    }

    .btn-yellow {
      background-color: #e6b400;
      color: white;
    }

    .btn-yellow:hover {
      background-color: #c79c00;
    }

    .btn-green {
      background-color: #007b5e;
      color: white;
    }

    .btn-green:hover {
      background-color: #005f47;
    }

    .btn-red {
      background-color: #d9534f;
      color: white;
    }

    .btn-red:hover {
      background-color: #b52b27;
    }

    .status {
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: bold;
      display: inline-block;
    }
    .status-已提交 { background-color: #d0e7ff; color: #004b91; }
    .status-审核中 { background-color: #fff3cd; color: #856404; }
    .status-已完成 { background-color: #d4edda; color: #155724; }
    .status-拒绝 { background-color: #f8d7da; color: #721c24; }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #004b91;
    }
  </style>
</head>

<body>
  <div class="header-bar">
    <div class="logo">📘 RM 账单系统</div>
    <div>
      当前用户：<span id="who"></span>
      <button class="btn btn-blue" onclick="logout()">登出</button>
      <a href="/submit.html" class="btn btn-green">➕ 新增账单</a>
      <a href="/dashboard.html" class="btn btn-yellow">📊 Dashboard</a>
    </div>
  </div>

  <h2>我的账单（演示版）</h2>

  <table id="claimsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>提交人</th>
        <th>金额</th>
        <th>用途</th>
        <th>银行</th>
        <th>账户</th>
        <th>状态</th>
        <th>创建时间</th>
        <th id="thActions" style="display:none;">操作</th>
      </tr>
    </thead>
    <tbody id="claimsBody"></tbody>
  </table>

  <script>
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let isAdmin = false;

    async function ensureProfile() {
      const { data: { user }, error: errUser } = await supabase.auth.getUser();
      if (errUser) throw errUser;
      if (!user) return null;

      const { data: prof } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .maybeSingle();

      const fullName =
        user.user_metadata?.full_name ||
        user.user_metadata?.name ||
        (user.email ? user.email.split('@')[0] : '未命名用户');

      if (!prof) {
        await supabase
          .from('profiles')
          .insert({ id: user.id, full_name: fullName, role: 'user' });
      } else {
        await supabase.from('profiles')
          .update({ full_name: fullName })
          .eq('id', user.id)
          .limit(1);
      }
      return user;
    }

    async function checkLoginAndRole() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert("请先登录！");
        window.location.href = "/login.html";
        return;
      }
      currentUser = session.user;
      await ensureProfile();

      document.getElementById('who').textContent = currentUser.email;

      const { data: prof } = await supabase
        .from('profiles')
        .select('role, full_name')
        .eq('id', currentUser.id)
        .maybeSingle();

      isAdmin = prof?.role === 'admin';
      if (isAdmin) document.getElementById('thActions').style.display = '';
    }

    async function loadClaims() {
      const { data, error } = await supabase
        .from("claims")
        .select("*")
        .order("created_at", { ascending: false });
      if (error) { alert("读取数据失败"); return; }

      const tbody = document.getElementById("claimsBody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.submitter_name || ''}</td>
          <td>${row.amount?.toFixed(2)}</td>
          <td>${row.purpose || ''}</td>
          <td>${row.bank_name || ''}</td>
          <td>${row.account_no || ''}</td>
          <td><span class="status status-${row.status}">${row.status}</span></td>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td>${isAdmin ? renderActions(row) : ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderActions(row) {
      if (row.status === '审核中') {
        return `
          <button class="btn btn-green" onclick="setStatus(${row.id}, '已完成')">✅ 通过</button>
          <button class="btn btn-red" onclick="setStatus(${row.id}, '拒绝')">❌ 拒绝</button>
        `;
      }
      return '';
    }

    async function setStatus(id, next) {
      const payload = { status: next };
      if (next === '审核中') payload.reviewed_at = new Date().toISOString();
      if (next === '已完成') payload.completed_at = new Date().toISOString();
      const { error } = await supabase.from('claims').update(payload).eq('id', id);
      if (error) alert('更新失败: ' + error.message);
      else loadClaims();
    }

    async function logout() {
      await supabase.auth.signOut();
      window.location.href = '/login.html';
    }

    (async function init() {
      await checkLoginAndRole();
      await loadClaims();
    })();
  </script>
</body>
</html>
