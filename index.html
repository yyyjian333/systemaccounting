<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RM è´¦å•åˆ—è¡¨</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ç»å…¸ç®€æ´é£æ ·å¼ -->
  <style>
    :root{
      --bg:#fafafa; --surface:#fff; --text:#222; --muted:#666; --border:#e5e5e5;
      --primary:#1f5fa3; --primary-600:#184c82;
      --green:#16a34a; --red:#dc2626; --yellow:#eab308; --blue:#2563eb;
      --radius:10px;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Microsoft Yahei',sans-serif}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .h-left{font-weight:700;font-size:18px}
    .h-right{display:flex;gap:8px;align-items:center;color:var(--muted)}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:7px 12px;cursor:pointer}
    .btn:hover{background:#f7f7f7}
    .btn-primary{border-color:#cbd5e1;background:#eef2ff}
    .muted{color:var(--muted)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .filters input,.filters select{border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{font-weight:600;background:#f6f6f6;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:10px;background:#fff}
    tr:hover td{background:#fafafa}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd}
    .b-blue{color:#1e40af;background:#eef2ff;border-color:#dbeafe}
    .b-yellow{color:#854d0e;background:#fff7d6;border-color:#fde68a}
    .b-green{color:#166534;background:#eaffee;border-color:#bbf7d0}
    .b-red{color:#9f1239;background:#ffe4e6;border-color:#fecdd3}
    .thumbs{display:flex;gap:6px;flex-wrap:wrap}
    .thumbs img{width:44px;height:44px;object-fit:cover;border:1px solid var(--border);border-radius:6px}
    .pdf{display:inline-block;padding:4px 6px;border:1px solid var(--border);border-radius:6px;text-decoration:none;color:var(--text)}
    .empty{padding:18px;text-align:center;color:var(--muted)}
    /* ç®€æ´å¼¹çª— */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px;width:100%;max-width:360px}
    .modal-content h3{margin:0 0 8px 0}
    .modal-content label{display:block;margin:8px 0 4px}
    .modal-content input{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .modal-actions{display:flex;gap:8px;margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="h-left">RM è´¦å•ç³»ç»Ÿ</div>
    <div class="h-right">
      <span>å½“å‰ç”¨æˆ·ï¼š<span id="who" class="muted">â€¦</span></span>
      <button class="btn" onclick="logout()">ç™»å‡º</button>
      <a class="btn" href="/submit.html">â• æ–°å¢è´¦å•</a>
      <a class="btn" href="/dashboard.html">ğŸ“Š Dashboard</a>
      <button class="btn btn-primary" onclick="openIncomeModal()">æ–°å¢è¿›è´¦</button>
    </div>
  </div>

  <h3 style="margin:10px 0 12px">æˆ‘çš„è´¦å•ï¼ˆæ¼”ç¤ºç‰ˆï¼‰</h3>

  <div class="card">
    <div class="filters">
      <input id="kw" placeholder="æœç´¢ï¼šå§“å/ç”¨é€”/é“¶è¡Œâ€¦" />
      <select id="st">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        <option value="å·²æäº¤">å·²æäº¤</option>
        <option value="å®¡æ ¸ä¸­">å®¡æ ¸ä¸­</option>
        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
        <option value="æ‹’ç»">æ‹’ç»</option>
      </select>
      <button id="btnSearch" class="btn">æœç´¢</button>
      <button id="btnClear" class="btn">æ¸…ç©º</button>
    </div>

    <div id="status" class="muted">æ­£åœ¨åŠ è½½â€¦</div>
    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>ID</th><th>æäº¤äºº</th><th>é‡‘é¢</th><th>ç”¨é€”</th>
          <th>é“¶è¡Œ</th><th>è´¦æˆ·</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ”¶æ®</th>
          <th id="thActions" style="display:none">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">æš‚æ— æ•°æ®</div>
  </div>
</div>

<!-- æ–°å¢è¿›è´¦å¼¹çª—ï¼ˆä¿ç•™ï¼Œä½†æ ·å¼æç®€ï¼‰ -->
<div id="incomeModal" class="modal">
  <div class="modal-content">
    <h3>æ–°å¢è¿›è´¦</h3>
    <label>é‡‘é¢ï¼ˆMYRï¼‰*</label>
    <input id="inAmount" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š1000.00" />
    <label>å¤‡æ³¨</label>
    <input id="inNote" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ·è½¬è´¦" />
    <label>æ—¥æœŸ</label>
    <input id="inDate" type="date" />
    <div class="modal-actions">
      <button class="btn" onclick="saveIncome()">ä¿å­˜</button>
      <button class="btn" onclick="closeIncomeModal()">å–æ¶ˆ</button>
    </div>
    <p id="incomeMsg" class="muted" style="margin:6px 0 0"></p>
  </div>
</div>

<script>
/* ===== Supabase åˆå§‹åŒ–ï¼šæ›¿æ¢ä½ çš„ URL / KEY ===== */
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false;
let currentUser = null;

/* ===== è‡ªåŠ¨å»ºæ¡£ï¼šé¦–æ¬¡ç™»å½•è‡ªåŠ¨åœ¨ profiles å†™å…¥ä¸€è¡Œ ===== */
async function ensureProfile() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return null;
  const { data: prof } = await supabase.from('profiles').select('id').eq('id', user.id).maybeSingle();
  const name = user.user_metadata?.full_name || user.user_metadata?.name || (user.email ? user.email.split('@')[0] : 'æœªå‘½åç”¨æˆ·');
  if (!prof) {
    await supabase.from('profiles').insert({ id: user.id, full_name: name, role: 'user' });
  } else {
    await supabase.from('profiles').update({ full_name: name }).eq('id', user.id).limit(1);
  }
  return user;
}

/* ===== ç™»å½•æ ¡éªŒ + è§’è‰²åˆ¤å®š ===== */
async function checkLoginAndRole() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) { alert('è¯·å…ˆç™»å½•'); location.href='/login.html'; return; }
  currentUser = session.user;
  document.getElementById('who').textContent = currentUser.email ?? '';
  await ensureProfile();

  const { data: prof } = await supabase
    .from('profiles')
    .select('role, full_name')
    .eq('id', currentUser.id)
    .maybeSingle();
  isAdmin = prof?.role === 'admin';
  if (isAdmin) document.getElementById('thActions').style.display = '';
}

/* ===== è¯»å–åˆ—è¡¨ ===== */
function badgeClass(st){
  if(st==='å·²å®Œæˆ') return 'b-green';
  if(st==='å®¡æ ¸ä¸­') return 'b-yellow';
  if(st==='æ‹’ç»') return 'b-red';
  return 'b-blue'; // å·²æäº¤
}
const esc = s => String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function renderThumb(url){
  if (/\.pdf(\?|$)/i.test(url)) return `<a class="pdf" href="${url}" target="_blank" rel="noopener">PDF</a>`;
  return `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="receipt"></a>`;
}

async function loadClaims({kw='',st=''}={}){
  const status=document.getElementById('status');
  const tbl=document.getElementById('tbl');
  const rows=document.getElementById('rows');
  const empty=document.getElementById('empty');

  status.style.display=''; tbl.style.display='none'; empty.style.display='none';
  status.textContent='æ­£åœ¨åŠ è½½â€¦';

  let q = supabase.from('claims').select('id,submitter_name,amount,purpose,bank_name,account_no,status,created_at').order('created_at',{ascending:false});
  if (kw) {
    const k = kw.replace(/,/g,'');
    q = q.or(`submitter_name.ilike.%${k}%,purpose.ilike.%${k}%,bank_name.ilike.%${k}%`);
  }
  if (st) q = q.eq('status', st);

  const { data: claims, error } = await q;
  if (error){ console.error(error); alert('è¯»å–æ•°æ®å¤±è´¥ï¼š'+error.message); return; }

  if (!claims || !claims.length){ status.style.display='none'; empty.style.display=''; rows.innerHTML=''; return; }

  const ids = claims.map(c=>c.id);
  const { data: atts } = await supabase.from('attachments').select('claim_id,file_url,type').in('claim_id', ids);
  const map=new Map(); (atts||[]).forEach(a=>{ if(!map.has(a.claim_id)) map.set(a.claim_id,[]); map.get(a.claim_id).push(a); });

  status.style.display='none'; tbl.style.display='';

  rows.innerHTML = claims.map(c=>{
    const list = map.get(c.id)||[];
    const thumbs = list.length ? `<div class="thumbs">${list.slice(0,4).map(a=>renderThumb(a.file_url)).join('')}</div>` : '<span class="muted">æ— </span>';
    let actions='';
    if (isAdmin){
      if (c.status==='å·²æäº¤'){
        actions = `<button class="btn" onclick="setStatus(${c.id},'å®¡æ ¸ä¸­')">è®¾ä¸ºå®¡æ ¸ä¸­</button>`;
      }else if (c.status==='å®¡æ ¸ä¸­'){
        actions = `<button class="btn" onclick="setStatus(${c.id},'å·²å®Œæˆ')">è®¾ä¸ºå·²å®Œæˆ</button>
                   <button class="btn" onclick="setStatus(${c.id},'å·²æäº¤')" style="margin-left:6px">é€€å›å·²æäº¤</button>
                   <button class="btn" onclick="setStatus(${c.id},'æ‹’ç»')" style="margin-left:6px">æ‹’ç»</button>`;
      }
    }
    return `<tr>
      <td>${c.id}</td>
      <td>${esc(c.submitter_name)}</td>
      <td>${Number(c.amount).toFixed(2)}</td>
      <td>${esc(c.purpose)}</td>
      <td>${esc(c.bank_name)}</td>
      <td>${esc(c.account_no)}</td>
      <td><span class="badge ${badgeClass(c.status)}">${esc(c.status)}</span></td>
      <td>${new Date(c.created_at).toLocaleString()}</td>
      <td>${thumbs}</td>
      <td>${actions}</td>
    </tr>`;
  }).join('');
}

async function setStatus(id, next){
  const payload={status:next};
  if (next==='å®¡æ ¸ä¸­') payload.reviewed_at=new Date().toISOString();
  if (next==='å·²å®Œæˆ')  payload.completed_at=new Date().toISOString();
  const { error } = await supabase.from('claims').update(payload).eq('id', id);
  if (error){ alert('æ›´æ–°å¤±è´¥ï¼š'+error.message); return; }
  loadClaims({kw:document.getElementById('kw').value.trim(), st:document.getElementById('st').value});
}

async function logout(){ await supabase.auth.signOut(); location.href='/login.html'; }

/* ===== æœç´¢äº‹ä»¶ ===== */
document.getElementById('btnSearch').addEventListener('click', ()=>{
  loadClaims({kw:document.getElementById('kw').value.trim(), st:document.getElementById('st').value});
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('kw').value=''; document.getElementById('st').value='';
  loadClaims({});
});

/* ===== æ–°å¢è¿›è´¦ï¼ˆä¿ç•™ã€æç®€ï¼‰ ===== */
function openIncomeModal(){ document.getElementById('incomeModal').style.display='flex'; document.getElementById('inDate').value = new Date().toISOString().slice(0,10); document.getElementById('incomeMsg').textContent=''; }
function closeIncomeModal(){ document.getElementById('incomeModal').style.display='none'; }
async function saveIncome(){
  const amount=parseFloat(document.getElementById('inAmount').value);
  const note=document.getElementById('inNote').value.trim();
  const date=document.getElementById('inDate').value;
  const msg=document.getElementById('incomeMsg');
  if(!amount){ msg.textContent='è¯·å¡«å†™é‡‘é¢'; return; }
  const { error } = await supabase.from('transactions').insert({ kind:'in', amount, note, occurred_at: date? new Date(date): new Date() });
  if (error){ msg.textContent='ä¿å­˜å¤±è´¥ï¼š'+error.message; return; }
  msg.textContent='ä¿å­˜æˆåŠŸ'; setTimeout(()=>{ closeIncomeModal(); }, 600);
}

/* ===== åˆå§‹åŒ– ===== */
(async function init(){
  await checkLoginAndRole();
  await loadClaims();
})();
</script>
</body>
</html>
