<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>System Accounting - Claims</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--card:#fafafa;--bd:#eee;--txt:#222;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1100px;margin:28px auto;padding:0 16px;color:var(--txt)}
    h1{font-size:20px;margin:0 0 16px}
    .nav{margin-bottom:12px}
    .nav a{margin-right:12px}
    .card{border:1px solid var(--bd);border-radius:12px;padding:16px;background:var(--card)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--bd);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th{font-weight:600}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;color:#334;font-size:12px}
    .muted{color:var(--muted)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs a{display:inline-block}
    .thumbs img{height:48px;width:auto;border-radius:6px;border:1px solid var(--bd);object-fit:cover}
    .empty{padding:24px;text-align:center;color:var(--muted)}
    .pdf{display:inline-block;padding:4px 6px;border:1px solid var(--bd);border-radius:6px;text-decoration:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav">
    <a href="/submit.html">â• æ–°å¢è´¦å•</a>
  </div>

  <h1>ğŸ“’ æˆ‘çš„è´¦å•ï¼ˆæ¼”ç¤ºç‰ˆï¼‰</h1>
  <div class="card">
    <div id="status">æ­£åœ¨ä» Supabase è¯»å–æ•°æ®â€¦</div>
    <table id="tbl" style="display:none">
      <thead>
      <tr>
        <th>ID</th>
        <th>æäº¤äºº</th>
        <th>é‡‘é¢</th>
        <th>ç”¨é€”</th>
        <th>é“¶è¡Œ</th>
        <th>è´¦æˆ·</th>
        <th>çŠ¶æ€</th>
        <th>åˆ›å»ºæ—¶é—´</th>
        <th>æ”¶æ®</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">ç›®å‰è¿˜æ²¡æœ‰æ•°æ®ï¼Œç‚¹å·¦ä¸Šè§’ã€Œæ–°å¢è´¦å•ã€è¯•è¯•ï½</div>
  </div>

  <script>
    const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";           // ä¾‹å¦‚ï¼šhttps://jdzytjocdkuzjtuwygdl.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw"; // ä½ çš„ anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // è¯»å– claimsï¼Œå¹¶æŠŠå…³è” attachments ä¸€èµ·å–å‡º
    async function loadClaims(){
      const status = document.getElementById('status');
      const table  = document.getElementById('tbl');
      const tbody  = document.getElementById('rows');
      const empty  = document.getElementById('empty');

      status.textContent = "æ­£åœ¨åŠ è½½â€¦";

      // å…³é”®ï¼šåµŒå¥—é€‰æ‹© attachments(*) ä¾èµ– claims.id -> attachments.claim_id çš„å¤–é”®
      const { data, error } = await supabase
        .from('claims')
        .select('id, submitter_name, amount, purpose, bank_name, account_no, status, created_at, attachments(* )')
        .order('created_at', { ascending: false });

      if (error) {
        status.textContent = "è¯»å–å¤±è´¥ï¼š" + error.message;
        console.error(error);
        return;
      }

      if (!data || !data.length) {
        status.style.display = 'none';
        empty.style.display = '';
        return;
      }

      status.style.display = 'none';
      table.style.display  = '';

      tbody.innerHTML = data.map(c => {
        const atts = Array.isArray(c.attachments) ? c.attachments : [];
        const cell = atts.length
          ? `<div class="thumbs">
               ${atts.slice(0,3).map(a => renderThumb(a.file_url)).join('')}
               ${atts.length > 3 ? `<span class="muted">+${atts.length-3} æ›´å¤šâ€¦</span>` : ''}
             </div>`
          : `<span class="muted">æ— </span>`;

        return `
          <tr>
            <td>${c.id}</td>
            <td>${escapeHtml(c.submitter_name || '')}</td>
            <td>${Number(c.amount).toFixed(2)}</td>
            <td>${escapeHtml(c.purpose || '')}</td>
            <td>${escapeHtml(c.bank_name || '')}</td>
            <td>${escapeHtml(c.account_no || '')}</td>
            <td><span class="badge">${escapeHtml(c.status || '')}</span></td>
            <td>${new Date(c.created_at).toLocaleString()}</td>
            <td>${cell}</td>
          </tr>
        `;
      }).join('');
    }

    // æ ¹æ®é“¾æ¥ç±»å‹æ¸²æŸ“ç¼©ç•¥å›¾ï¼ˆå›¾ç‰‡æ˜¾ç¤ºç¼©ç•¥å›¾ï¼ŒPDF æ˜¾ç¤ºæŒ‰é’®ï¼‰
    function renderThumb(url){
      const isPdf = /\.pdf(\?|$)/i.test(url);
      if (isPdf) {
        return `<a class="pdf" href="${url}" target="_blank" rel="noopener">PDF</a>`;
      }
      return `<a href="${url}" target="_blank" rel="noopener">
                <img src="${url}" alt="receipt" />
              </a>`;
    }

    // ç®€å•è½¬ä¹‰ï¼Œé¿å…å¼‚å¸¸å­—ç¬¦ç ´åé¡µé¢
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    loadClaims();
  </script>
</body>
</html>
