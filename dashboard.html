<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Â· æ”¶æ”¯å›¾è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--card:#fafafa;--bd:#eee;--txt:#222;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1100px;margin:28px auto;padding:0 16px;color:var(--txt)}
    h1{font-size:20px;margin:0 0 16px}
    .nav{margin-bottom:16px}
    .nav a{margin-right:12px}
    .card{border:1px solid var(--bd);border-radius:12px;background:var(--card);padding:16px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{border:1px solid var(--bd);border-radius:12px;background:#fff;padding:14px}
    .kpi h3{margin:0 0 4px;font-size:13px;color:var(--muted)}
    .kpi div{font-size:22px;font-weight:700}
    canvas{width:100%;height:340px;max-height:340px}
    .muted{color:var(--muted)}
  </style>
  <!-- Supabase + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <div class="nav">
    <a href="/">â† è¿”å›åˆ—è¡¨</a>
  </div>
  <h1>ğŸ“Š æ”¶æ”¯æ€»è§ˆ</h1>

  <!-- KPIs -->
  <div class="grid">
    <div class="kpi"><h3>æœ¬å‘¨ Â· è¿›è´¦</h3><div id="wkIn">-</div></div>
    <div class="kpi"><h3>æœ¬å‘¨ Â· å‡ºè´¦</h3><div id="wkOut">-</div></div>
    <div class="kpi"><h3>æœ¬å‘¨ Â· ç»“ä½™</h3><div id="wkNet">-</div></div>
  </div>
  <div class="grid">
    <div class="kpi"><h3>æœ¬æœˆ Â· è¿›è´¦</h3><div id="moIn">-</div></div>
    <div class="kpi"><h3>æœ¬æœˆ Â· å‡ºè´¦</h3><div id="moOut">-</div></div>
    <div class="kpi"><h3>æœ¬æœˆ Â· ç»“ä½™</h3><div id="moNet">-</div></div>
  </div>
  <div class="grid">
    <div class="kpi"><h3>æœ¬å¹´ Â· è¿›è´¦</h3><div id="yrIn">-</div></div>
    <div class="kpi"><h3>æœ¬å¹´ Â· å‡ºè´¦</h3><div id="yrOut">-</div></div>
    <div class="kpi"><h3>æœ¬å¹´ Â· ç»“ä½™</h3><div id="yrNet">-</div></div>
  </div>

  <!-- Charts -->
  <div class="card">
    <h3>è¿‘ 12 å‘¨</h3>
    <canvas id="chartWeek"></canvas>
    <div class="muted">è¯´æ˜ï¼šè¿›è´¦æ¥è‡ª transactions[in]ï¼›å‡ºè´¦æ¥è‡ª transactions[out] + claims(å·²å®Œæˆ)ã€‚</div>
  </div>
  <div class="card">
    <h3>æœ¬å¹´ï¼ˆæŒ‰æœˆï¼‰</h3>
    <canvas id="chartMonth"></canvas>
  </div>
  <div class="card">
    <h3>å†å¹´ï¼ˆæŒ‰å¹´ï¼‰</h3>
    <canvas id="chartYear"></canvas>
  </div>

  <script>
    // 1) æ›¿æ¢ä¸ºä½ çš„é¡¹ç›®é…ç½®
    const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";           // ä¾‹å¦‚ï¼šhttps://jdzytjocdkuzjtuwygdl.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw"; // ä½ çš„ anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // è‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€
  async function checkLogin() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      alert("è¯·å…ˆç™»å½•ï¼");
      window.location.href = "/login.html";
      return null;
    }
    return session.user;
  }

  // ä¸€è¿›å…¥é¡µé¢å°±æ£€æŸ¥æ˜¯å¦ç™»å½•
  checkLogin();


    // 2) å·¥å…·å‡½æ•°
    const sum = arr => arr.reduce((a,b)=>a+b,0);
    const fmtMoney = n => 'RM ' + (Number(n||0)).toFixed(2);
    const startOfWeek = d => { // ä»¥å‘¨ä¸€ä¸ºä¸€å‘¨å¼€å§‹
      const dt = new Date(d); const day = (dt.getDay()+6)%7; dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt;
    };
    const startOfMonth = d => { const dt = new Date(d); dt.setDate(1); dt.setHours(0,0,0,0); return dt; };
    const startOfYear  = d => { const dt = new Date(d); dt.setMonth(0,1); dt.setHours(0,0,0,0); return dt; };
    const ymd = d => { const dt = new Date(d); const m = String(dt.getMonth()+1).padStart(2,'0'); const day = String(dt.getDate()).padStart(2,'0'); return `${dt.getFullYear()}-${m}-${day}`; };
    const ym  = d => { const dt = new Date(d); const m = String(dt.getMonth()+1).padStart(2,'0'); return `${dt.getFullYear()}-${m}`; };

    // 3) æ‹‰å–æ•°æ®ï¼štransactions (in/out) + claims(å·²å®Œæˆ=out)
    async function fetchData(){
      const now = new Date();
      const since = new Date(now); since.setFullYear(now.getFullYear()-3); // è¿‘ä¸‰å¹´

      // transactionsï¼ˆin/outï¼‰
      const { data: tx, error: e1 } = await supabase
        .from('transactions')
        .select('kind, amount, occurred_at')
        .gte('occurred_at', since.toISOString());

      if (e1) { console.error(e1); alert('è¯»å– transactions å¤±è´¥ï¼š'+e1.message); }

      // claimsï¼ˆå·²å®Œæˆ -> è§†ä¸º outï¼‰
      const { data: claims, error: e2 } = await supabase
        .from('claims')
        .select('amount, status, created_at, completed_at')
        .gte('created_at', since.toISOString());

      if (e2) { console.error(e2); alert('è¯»å– claims å¤±è´¥ï¼š'+e2.message); }

      const entries = [];

      // transactions -> entries
      (tx||[]).forEach(t => {
        if (!t || !t.kind) return;
        const when = t.occurred_at || new Date().toISOString();
        entries.push({ kind: t.kind, amount: Number(t.amount||0), date: when });
      });

      // claims.completed -> entries(out)
      (claims||[]).forEach(c => {
        if (c.status === 'å·²å®Œæˆ') {
          const when = c.completed_at || c.created_at;
          entries.push({ kind: 'out', amount: Number(c.amount||0), date: when });
        }
      });

      return entries;
    }

    // 4) æŒ‰å‘¨ / æœˆ / å¹´æ±‡æ€»
    function bucketWeek(entries){
      // ç”Ÿæˆè¿‘ 12 å‘¨æ ‡ç­¾ï¼Œä»å½“å‰å‘¨å¾€å‰
      const arr = [];
      const now = new Date(); let cur = startOfWeek(now);
      for (let i=11;i>=0;i--){
        const dt = new Date(cur); dt.setDate(cur.getDate() - i*7);
        arr.push(dt);
      }
      const labels = arr.map(d => ymd(d)); // å‘¨èµ·å§‹æ—¥
      const inVals  = labels.map(()=>0);
      const outVals = labels.map(()=>0);

      entries.forEach(e=>{
        const idx = labels.findIndex(label => {
          const wk = startOfWeek(e.date);
          return ymd(wk) === label;
        });
        if (idx>=0){
          if (e.kind==='in')  inVals[idx]+=e.amount;
          if (e.kind==='out') outVals[idx]+=e.amount;
        }
      });
      return { labels, inVals, outVals };
    }

    function bucketMonth(entries){
      // æœ¬å¹´ 12 ä¸ªæœˆ
      const now = new Date();
      const labels = [];
      for (let m=0;m<12;m++){
        const dt = new Date(now.getFullYear(), m, 1);
        labels.push(ym(dt));
      }
      const inVals  = labels.map(()=>0);
      const outVals = labels.map(()=>0);
      entries.forEach(e=>{
        const k = ym(e.date);
        const idx = labels.indexOf(k);
        if (idx>=0){
          if (e.kind==='in')  inVals[idx]+=e.amount;
          if (e.kind==='out') outVals[idx]+=e.amount;
        }
      });
      return { labels, inVals, outVals };
    }

    function bucketYear(entries){
      const map = new Map(); // year -> {in,out}
      entries.forEach(e=>{
        const y = new Date(e.date).getFullYear();
        if (!map.has(y)) map.set(y, {in:0,out:0});
        const obj = map.get(y);
        if (e.kind==='in')  obj.in  += e.amount;
        if (e.kind==='out') obj.out += e.amount;
      });
      const years = Array.from(map.keys()).sort((a,b)=>a-b);
      const inVals  = years.map(y=>map.get(y).in);
      const outVals = years.map(y=>map.get(y).out);
      return { labels: years.map(String), inVals, outVals };
    }

    // 5) ç”»å›¾ + å¡« KPI
    let chW, chM, chY;
    function drawBar(ctx, labels, inVals, outVals){
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'è¿›è´¦', data: inVals },
            { label: 'å‡ºè´¦', data: outVals }
          ]
        },
        options: { responsive:true, maintainAspectRatio:false }
      });
    }

    function fillKPIs(entries){
      const now = new Date();
      const w0 = startOfWeek(now), m0 = startOfMonth(now), y0 = startOfYear(now);
      const wk = entries.filter(e => startOfWeek(e.date).getTime() === w0.getTime());
      const mo = entries.filter(e => startOfMonth(e.date).getTime() === m0.getTime());
      const yr = entries.filter(e => startOfYear(e.date).getTime()  === y0.getTime());

      const t = (list, kind) => sum(list.filter(e=>e.kind===kind).map(e=>e.amount));
      const wkIn=t(wk,'in'),  wkOut=t(wk,'out');
      const moIn=t(mo,'in'),  moOut=t(mo,'out');
      const yrIn=t(yr,'in'),  yrOut=t(yr,'out');

      document.getElementById('wkIn').textContent  = fmtMoney(wkIn);
      document.getElementById('wkOut').textContent = fmtMoney(wkOut);
      document.getElementById('wkNet').textContent = fmtMoney(wkIn - wkOut);

      document.getElementById('moIn').textContent  = fmtMoney(moIn);
      document.getElementById('moOut').textContent = fmtMoney(moOut);
      document.getElementById('moNet').textContent = fmtMoney(moIn - moOut);

      document.getElementById('yrIn').textContent  = fmtMoney(yrIn);
      document.getElementById('yrOut').textContent = fmtMoney(yrOut);
      document.getElementById('yrNet').textContent = fmtMoney(yrIn - yrOut);
    }

    // 6) ä¸»æµç¨‹
    (async function main(){
      const entries = await fetchData();

      // KPI
      fillKPIs(entries);

      // Week
      const w = bucketWeek(entries);
      chW = drawBar(document.getElementById('chartWeek'), w.labels, w.inVals, w.outVals);

      // Month
      const m = bucketMonth(entries);
      chM = drawBar(document.getElementById('chartMonth'), m.labels, m.inVals, m.outVals);

      // Year
      const y = bucketYear(entries);
      chY = drawBar(document.getElementById('chartYear'), y.labels, y.inVals, y.outVals);
    })();
  </script>
</body>
</html>
