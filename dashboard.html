<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Dashboard · RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fbf7ee; --surface:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#d4a016; --primary-600:#b4840e; --primary-100:#fff4d1;
      --info:#1f5fa3; --info-600:#164a80; --success:#16a34a;
      --radius:12px; --shadow:0 6px 18px rgba(0,0,0,.06);
    }
    body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang SC","Microsoft Yahei","Noto Sans CJK SC",sans-serif;max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px;font-weight:700}
    .nav{margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:9px 14px;font-size:14px;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.05)}
    .btn-info{background:#1f5fa3;color:#fff}.btn-info:hover{background:#164a80}
    .btn-ghost{background:#f3f4f6;color:#111}
    .who{font-size:12px;color:var(--muted);margin-left:8px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:6px}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
    .kpi h3{font-size:13px;color:#6b7280;margin:0 0 4px}
    .kpi div{font-size:22px;font-weight:700}
    canvas{width:100%;height:340px;max-height:340px}
    .muted{color:#6b7280}

    /* 🏦 账户余额样式 */
    .balances-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:12px;
      margin-top:10px;
    }
    .balance-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .balance-name{font-weight:700;margin-bottom:4px}
    .balance-amt{font-size:18px;color:var(--info);font-weight:700}
    .balance-sub{font-size:12px;color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <div class="nav">
    <a class="btn btn-info" href="/index.html">← 返回列表</a>
    <a class="btn btn-ghost" href="#" onclick="logout()">🚪 登出</a>
    <span id="who" class="who"></span>
  </div>

  <h1>📊 收支总览</h1>

  <div class="grid">
    <div class="kpi"><h3>本周 · 进账</h3><div id="wkIn">-</div></div>
    <div class="kpi"><h3>本周 · 出账</h3><div id="wkOut">-</div></div>
    <div class="kpi"><h3>本周 · 结余</h3><div id="wkNet">-</div></div>
  </div>
  <div class="grid">
    <div class="kpi"><h3>本月 · 进账</h3><div id="moIn">-</div></div>
    <div class="kpi"><h3>本月 · 出账</h3><div id="moOut">-</div></div>
    <div class="kpi"><h3>本月 · 结余</h3><div id="moNet">-</div></div>
  </div>
  <div class="grid">
    <div class="kpi"><h3>本年 · 进账</h3><div id="yrIn">-</div></div>
    <div class="kpi"><h3>本年 · 出账</h3><div id="yrOut">-</div></div>
    <div class="kpi"><h3>本年 · 结余</h3><div id="yrNet">-</div></div>
  </div>

  <!-- 🏦 新增：账户余额模块 -->
  <div class="card">
   <div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3>🏦 各账户余额</h3>
    <button class="btn btn-info" style="padding:6px 12px;font-size:13px" onclick="openAddAccount()">＋ 新增户口</button>
  </div>

  <div id="balancesWrap" class="balances-grid">加载中...</div>
  <div id="balancesTotal" style="margin-top:8px;font-weight:600;"></div>
</div>

    <!-- 弹出框 -->
  <div id="accountModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:20px;border-radius:12px;min-width:300px;box-shadow:0 8px 24px rgba(0,0,0,.2);">
      <h3 style="margin-top:0">新增户口</h3>
      <label style="font-size:13px">账户名称：</label>
      <input id="newAccName" type="text" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px">
      <label style="font-size:13px;margin-top:8px;display:block;">初始余额：</label>
      <input id="newAccBalance" type="number" step="0.01" placeholder="0.00" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px">
      <div style="margin-top:14px;text-align:right">
        <button class="btn btn-ghost" onclick="closeAddAccount()">取消</button>
        <button class="btn btn-info" onclick="saveNewAccount()">保存</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>近 12 周</h3>
    <canvas id="chartWeek"></canvas>
    <div class="muted">说明：进账来自 transactions[in]；出账来自 transactions[out] + claims(已完成)。</div>
  </div>
  <div class="card">
    <h3>本年（按月）</h3>
    <canvas id="chartMonth"></canvas>
  </div>
  <div class="card">
    <h3>历年（按年）</h3>
    <canvas id="chartYear"></canvas>
  </div>

<script>
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const sum = arr => arr.reduce((a,b)=>a+b,0);
const fmt = n => 'RM ' + (Number(n||0)).toFixed(2);
const startOfWeek=d=>{const t=new Date(d),k=(t.getDay()+6)%7;t.setHours(0,0,0,0);t.setDate(t.getDate()-k);return t;}
const startOfMonth=d=>{const t=new Date(d);t.setDate(1);t.setHours(0,0,0,0);return t;}
const startOfYear=d=>{const t=new Date(d);t.setMonth(0,1);t.setHours(0,0,0,0);return t;}
const ymd=d=>{const t=new Date(d);const m=String(t.getMonth()+1).padStart(2,'0');const dd=String(t.getDate()).padStart(2,'0');return `${t.getFullYear()}-${m}-${dd}`;}
const ym=d=>{const t=new Date(d);const m=String(t.getMonth()+1).padStart(2,'0');return `${t.getFullYear()}-${m}`;}

async function checkLogin(){ const {data:{session}}=await supabase.auth.getSession(); if(!session){alert('请先登录');location.href='/login.html';return;} document.getElementById('who').textContent=session.user.email; }
async function logout(){ await supabase.auth.signOut(); location.href='/login.html'; }

async function fetchEntries(){
  const now=new Date(); const since=new Date(now); since.setFullYear(now.getFullYear()-3);
  const {data:tx}=await supabase.from('transactions').select('kind,amount,occurred_at').gte('occurred_at',since.toISOString());
  const {data:claims}=await supabase.from('claims').select('amount,status,created_at,completed_at').gte('created_at',since.toISOString());

  const entries=[];
  (tx||[]).forEach(t=>{if(!t||!t.kind)return;entries.push({kind:t.kind,amount:Number(t.amount||0),date:t.occurred_at||new Date().toISOString()});});
  (claims||[]).forEach(c=>{if(c.status==='已完成'){entries.push({kind:'out',amount:Number(c.amount||0),date:c.completed_at||c.created_at});}});
  return entries;
}

function bucketWeek(entries){
  const arr=[]; const cur=startOfWeek(new Date()); for(let i=11;i>=0;i--){const dt=new Date(cur); dt.setDate(cur.getDate()-i*7); arr.push(dt);}
  const labels=arr.map(ymd); const IN=labels.map(()=>0), OUT=labels.map(()=>0);
  entries.forEach(e=>{const idx=labels.findIndex(l=>ymd(startOfWeek(e.date))===l); if(idx>=0){ if(e.kind==='in')IN[idx]+=e.amount; if(e.kind==='out')OUT[idx]+=e.amount; }});
  return{labels,inVals:IN,outVals:OUT};
}
function bucketMonth(entries){
  const now=new Date(); const labels=[]; for(let m=0;m<12;m++){labels.push(ym(new Date(now.getFullYear(),m,1)));}
  const IN=labels.map(()=>0), OUT=labels.map(()=>0);
  entries.forEach(e=>{const k=ym(e.date); const i=labels.indexOf(k); if(i>=0){ if(e.kind==='in')IN[i]+=e.amount; if(e.kind==='out')OUT[i]+=e.amount; }});
  return{labels,inVals:IN,outVals:OUT};
}
function bucketYear(entries){
  const mp=new Map(); entries.forEach(e=>{const y=new Date(e.date).getFullYear(); if(!mp.has(y)) mp.set(y,{in:0,out:0}); const o=mp.get(y); if(e.kind==='in')o.in+=e.amount; else if(e.kind==='out')o.out+=e.amount; });
  const ys=Array.from(mp.keys()).sort((a,b)=>a-b); return{labels:ys.map(String),inVals:ys.map(y=>mp.get(y).in),outVals:ys.map(y=>mp.get(y).out)};
}
function draw(id,labels,a,b){return new Chart(document.getElementById(id),{type:'bar',data:{labels,datasets:[{label:'进账',data:a,backgroundColor:'#1f5fa3'},{label:'出账',data:b,backgroundColor:'#d4a016'}]},options:{responsive:true,maintainAspectRatio:false}});}

function fillKPI(entries){
  const now=new Date(); const w0=startOfWeek(now), m0=startOfMonth(now), y0=startOfYear(now);
  const fil=(list,kind)=>sum(list.filter(e=>e.kind===kind).map(e=>e.amount));
  const W=entries.filter(e=>startOfWeek(e.date).getTime()===w0.getTime());
  const M=entries.filter(e=>startOfMonth(e.date).getTime()===m0.getTime());
  const Y=entries.filter(e=>startOfYear(e.date).getTime()===y0.getTime());
  const wkIn=fil(W,'in'),wkOut=fil(W,'out'); document.getElementById('wkIn').textContent=fmt(wkIn); document.getElementById('wkOut').textContent=fmt(wkOut); document.getElementById('wkNet').textContent=fmt(wkIn-wkOut);
  const moIn=fil(M,'in'),moOut=fil(M,'out'); document.getElementById('moIn').textContent=fmt(moIn); document.getElementById('moOut').textContent=fmt(moOut); document.getElementById('moNet').textContent=fmt(moIn-moOut);
  const yrIn=fil(Y,'in'),yrOut=fil(Y,'out'); document.getElementById('yrIn').textContent=fmt(yrIn); document.getElementById('yrOut').textContent=fmt(yrOut); document.getElementById('yrNet').textContent=fmt(yrIn-yrOut);
}

/* 🏦 载入账户余额 */
async function loadBalances(){
  const grid=document.getElementById('balancesWrap');
  const total=document.getElementById('balancesTotal');
  grid.innerHTML='加载中…';
  const {data,error}=await supabase.from('accounts').select('id,name,balance').order('name');
  if(error){grid.textContent='读取失败：'+error.message;return;}
  if(!data||!data.length){grid.textContent='暂无账户';return;}
grid.innerHTML=data.map(a=>`
  <div class="balance-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="balance-name">${a.name}</div>
      <button onclick="deleteAccount(${a.id}, '${a.name}')" 
        style="background:none;border:none;color:#dc2626;font-size:16px;cursor:pointer;">✕</button>
    </div>
    <div class="balance-amt">RM ${(Number(a.balance)||0).toFixed(2)}</div>
    <div class="balance-sub">更新于 ${new Date().toLocaleString()}</div>
  </div>`).join('');
  const sumAll=data.reduce((s,a)=>s+Number(a.balance||0),0);
  total.innerHTML=`合计余额：<strong style="color:var(--info)">RM ${sumAll.toFixed(2)}</strong>`;
}
  
// 打开新增户口弹窗
function openAddAccount(){
  document.getElementById('accountModal').style.display='flex';
  document.getElementById('newAccName').focus();
}
// 关闭
function closeAddAccount(){
  document.getElementById('accountModal').style.display='none';
  document.getElementById('newAccName').value='';
  document.getElementById('newAccBalance').value='';
}
// 保存新账户
async function saveNewAccount(){
  const name = document.getElementById('newAccName').value.trim();
  const balance = parseFloat(document.getElementById('newAccBalance').value||0);
  if(!name){ alert('请输入账户名称'); return; }

  const { error } = await supabase.from('accounts').insert({ name, balance });
  if(error){ alert('保存失败：'+error.message); return; }

  alert('✅ 新户口已添加');
  closeAddAccount();
  loadBalances();
}

/* 初始化 */
(async function(){
  await checkLogin();
  await loadBalances();
  const entries=await fetchEntries();
  fillKPI(entries);
  const w=bucketWeek(entries); draw('chartWeek', w.labels, w.inVals, w.outVals);
  const m=bucketMonth(entries); draw('chartMonth', m.labels, m.inVals, m.outVals);
  const y=bucketYear(entries); draw('chartYear', y.labels, y.inVals, y.outVals);
})();
</script>
</body>
</html>
