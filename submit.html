<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>æ–°å¢è´¦å•ï¼ˆå¯å¤šå¼ æ”¶æ®ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:720px;margin:24px auto;padding:0 16px;}
    h1{font-size:20px;margin:0 0 16px}
    .card{border:1px solid #eee;border-radius:10px;padding:16px;background:#fafafa}
    label{display:block;margin:10px 0 6px}
    input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    button{margin-top:14px;padding:10px 14px;border:0;border-radius:8px;background:#111;color:#fff;font-size:14px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .tip{margin:10px 0;color:#666}
    .nav{margin-bottom:14px}
    .nav a{margin-right:12px}
    .progress{font-size:12px;color:#666}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav"><a href="/">â† è¿”å›åˆ—è¡¨</a></div>
  <h1>ğŸ“ æ–°å¢è´¦å•ï¼ˆå¯å¤šå¼ æ”¶æ®ï¼‰</h1>
  <div class="card">
    <div class="tip">å¸¦æ˜Ÿå·çš„æ˜¯å¿…å¡«é¡¹ã€‚æ”¶æ®å¯ä¸€æ¬¡é€‰æ‹©å¤šå¼ ï¼ˆå›¾ç‰‡æˆ– PDFï¼Œå•æ–‡ä»¶ â‰¤ 10MBï¼‰ã€‚</div>
    <form id="f">
      <label>æäº¤äººå§“å *</label>
      <input id="name" required placeholder="ä¾‹å¦‚ï¼šAlice" />

      <label>é‡‘é¢ï¼ˆMYRï¼‰ *</label>
      <input id="amount" required type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š120.50" />

      <label>ç”¨é€”ï¼ˆä¹°äº†å•¥/ç”¨åœ¨å“ªé‡Œï¼‰ *</label>
      <textarea id="purpose" required rows="2" placeholder="ä¾‹å¦‚ï¼šä¹°æ‰“å°çº¸"></textarea>

      <label>é“¶è¡Œ *</label>
      <input id="bank" required placeholder="ä¾‹å¦‚ï¼šMaybank" />

      <label>è´¦æˆ·å· *</label>
      <input id="acct" required placeholder="ä¾‹å¦‚ï¼š112-345-6789" />

      <label>æ”¶æ®ï¼ˆå›¾ç‰‡æˆ– PDFï¼Œå¯å¤šé€‰ï¼‰</label>
      <input id="receipts" type="file" accept="image/*,application/pdf" multiple />

      <button id="btn" type="submit">æäº¤è´¦å•</button>
      <div id="msg" class="tip"></div>
      <div id="prog" class="progress"></div>
    </form>
  </div>

  <script>
    // ğŸ”§ æ›¿æ¢ä¸ºä½ çš„é¡¹ç›®é…ç½®
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('f');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const prog = document.getElementById('prog');
    const filesInput = document.getElementById('receipts');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true; msg.textContent = 'æäº¤ä¸­â€¦'; prog.textContent = '';

      const payload = {
        submitter_name: document.getElementById('name').value.trim(),
        amount: Number(document.getElementById('amount').value),
        purpose: document.getElementById('purpose').value.trim(),
        bank_name: document.getElementById('bank').value.trim(),
        account_no: document.getElementById('acct').value.trim(),
        status: 'å·²æäº¤'
      };

      if (!payload.submitter_name || !payload.amount || !payload.purpose || !payload.bank_name || !payload.account_no) {
        msg.textContent = 'è¯·æŠŠå¸¦æ˜Ÿå·çš„å†…å®¹å¡«å®Œæ•´ã€‚';
        btn.disabled = false; return;
      }

      // 1) æ’å…¥ claims
      const { data: inserted, error: insErr } = await supabase
        .from('claims')
        .insert(payload)
        .select('id')
        .single();

      if (insErr) {
        console.error(insErr);
        msg.textContent = 'æäº¤å¤±è´¥ï¼š' + insErr.message;
        btn.disabled = false; return;
      }
      const claimId = inserted.id;

      // 2) å¤šå¼ æ”¶æ®é€ä¸ªä¸Šä¼ 
      const files = Array.from(filesInput.files || []);
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        if (f.size > 10 * 1024 * 1024) { msg.textContent = `ç¬¬ ${i+1} ä¸ªæ–‡ä»¶è¶…è¿‡ 10MBï¼Œå·²è·³è¿‡`; continue; }

        prog.textContent = `æ­£åœ¨ä¸Šä¼ ç¬¬ ${i+1}/${files.length} å¼ â€¦`;
        const path = `${claimId}/${Date.now()}-${i}-${f.name}`;

        // ä¸Šä¼ åˆ° receipts æ¡¶
        const { error: upErr } = await supabase.storage.from('receipts').upload(path, f);
        if (upErr) { msg.textContent = 'æ”¶æ®ä¸Šä¼ å¤±è´¥ï¼š' + upErr.message; btn.disabled = false; return; }

        // å…¬å¼€ URL & å†™å…¥ attachments
        const { data: pub } = supabase.storage.from('receipts').getPublicUrl(path);
        const fileUrl = pub.publicUrl;

        const { error: attErr } = await supabase
          .from('attachments')
          .insert({ claim_id: claimId, file_url: fileUrl, type: 'receipt' });

        if (attErr) { msg.textContent = 'é™„ä»¶è®°å½•å¤±è´¥ï¼š' + attErr.message; btn.disabled = false; return; }
      }

      msg.textContent = 'æäº¤æˆåŠŸï¼å³å°†è¿”å›åˆ—è¡¨â€¦';
      setTimeout(() => { window.location.href = '/'; }, 600);
    });
  </script>
</body>
</html>
