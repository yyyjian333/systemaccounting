<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>æ–°å¢è´¦å• Â· RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fbf7ee; --surface:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#d4a016; --primary-600:#b4840e; --primary-100:#fff4d1;
      --info:#1f5fa3; --info-600:#164a80; --success:#16a34a; --danger:#dc2626;
      --radius:12px; --radius-sm:10px; --shadow:0 6px 18px rgba(0,0,0,.06); --shadow-sm:0 3px 10px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang SC","Microsoft Yahei","Noto Sans CJK SC",sans-serif;
      max-width:880px; margin:28px auto; padding:0 16px;
    }
    h1{font-size:22px;margin:0 0 14px;font-weight:700}
    .nav{margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:var(--radius-sm);padding:9px 14px;font-size:14px;cursor:pointer;transition:transform .08s,box-shadow .2s;box-shadow:var(--shadow-sm)}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-600)}
    .btn-info{background:var(--info);color:#fff}.btn-info:hover{background:var(--info-600)}
    .btn-ghost{background:#f3f4f6;color:#111}
    .who{font-size:12px;color:var(--muted);margin-left:8px}

    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 18px 16px;box-shadow:var(--shadow)}

    /* âœ… ä¸¤åˆ—ç½‘æ ¼ï¼Œé˜²æº¢å‡ºï¼šminmax(0,1fr) */
    .grid2{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:14px}
    .field{min-width:0} /* é˜²æ­¢å†…éƒ¨æ§ä»¶æ’‘ç ´åˆ— */
    label{font-size:13px;color:#374151;margin-bottom:6px;display:block}
    input,textarea,select{
      width:100%; max-width:100%;
      padding:11px 12px; border:1px solid var(--border); border-radius:var(--radius-sm);
      font-size:14px; background:#fff; outline:none;
    }
    input:focus,textarea:focus,select:focus{box-shadow:0 0 0 4px rgba(212,160,22,.12)}
    textarea{resize:vertical} /* åªå…è®¸ç«–å‘æ‹‰ä¼¸ï¼Œé¿å…æŠŠç½‘æ ¼æ¨ªå‘é¡¶çˆ† */

    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .muted{color:var(--muted)}
    .ok{color:var(--success)} .err{color:var(--danger)}

    /* æ–‡ä»¶åŒºåŸŸå°ä¼˜åŒ– */
    .filewrap{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px dashed var(--border); border-radius:var(--radius-sm);
      background:#fff;
    }
    .filewrap input[type="file"]{padding:6px; border:0; box-shadow:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav">
    <a class="btn btn-info" href="/index.html">â† è¿”å›åˆ—è¡¨</a>
    <a class="btn btn-ghost" href="#" onclick="logout()">ğŸšª ç™»å‡º</a>
    <span id="who" class="who"></span>
  </div>

  <h1>ğŸ§¾ æ–°å¢è´¦å•ï¼ˆå¯å¤šå¼ æ”¶æ®ï¼‰</h1>

  <div class="card">
    <div class="grid2">
      <div class="field">
        <label>æäº¤äººå§“å *</label>
        <input id="name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required />
      </div>
      <div class="field">
        <label>é‡‘é¢ï¼ˆMYRï¼‰ *</label>
        <input id="amount" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š120.00" required />
      </div>

      <div class="field">
        <label>ç”¨é€”ï¼ˆä¹°äº†å•¥/ç”¨åœ¨å“ªé‡Œï¼‰ *</label>
        <textarea id="purpose" rows="3" placeholder="ç®€å•æè¿°â€¦"></textarea>
      </div>
      <div class="field">
        <label>é“¶è¡Œ *</label>
        <input id="bank" placeholder="MAYBANK / CIMBâ€¦" />
        <div class="hint">å¯æ‰‹å¡«é“¶è¡Œå</div>
      </div>

      <div class="field">
        <label>è´¦æˆ·å· *</label>
        <input id="account" placeholder="ä¾‹å¦‚ï¼š112-345-6789" />
      </div>
      <div class="field">
        <label>æ”¶æ®ï¼ˆå¯å¤šé€‰ï¼ŒPDF æˆ– å›¾ç‰‡ï¼Œâ‰¤10MB/æ–‡ä»¶ï¼‰</label>
        <div class="filewrap">
          <input id="files" type="file" multiple accept="image/*,.pdf" />
          <div class="muted" id="fileHint">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px">
      <button class="btn btn-primary" onclick="submitClaim()">æäº¤è´¦å•</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function checkLogin(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ alert("è¯·å…ˆç™»å½•"); location.href="/login.html"; return; }
  document.getElementById('who').textContent = session.user.email;
}
async function logout(){ await supabase.auth.signOut(); location.href="/login.html"; }

const fileInput = document.getElementById('files');
const fileHint  = document.getElementById('fileHint');
fileInput?.addEventListener('change', () => {
  const n = fileInput.files?.length || 0;
  fileHint.textContent = n ? `å·²é€‰æ‹© ${n} ä¸ªæ–‡ä»¶` : 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
});

function setMsg(text, ok=false){
  const el=document.getElementById('msg');
  el.textContent=text;
  el.className = ok ? 'ok' : (text ? 'err' : 'muted');
}

async function submitClaim(){
  setMsg("æ­£åœ¨æäº¤â€¦", true);
  const submitter_name = document.getElementById('name').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const purpose = document.getElementById('purpose').value.trim();
  const bank_name = document.getElementById('bank').value.trim();
  const account_no = document.getElementById('account').value.trim();
  const files = document.getElementById('files').files;

  if(!submitter_name || !amount || !purpose || !bank_name || !account_no){
    setMsg("è¯·æŠŠå¿…å¡«ä¿¡æ¯å¡«å®Œæ•´"); return;
  }

  // 1) æ–°å»ºè´¦å•ï¼ˆçŠ¶æ€ï¼šå·²æäº¤ï¼‰
  const { data: claim, error: e1 } = await supabase
    .from('claims')
    .insert({ submitter_name, amount, purpose, bank_name, account_no, status:'å·²æäº¤' })
    .select('id')
    .single();

  if(e1){ setMsg("åˆ›å»ºè´¦å•å¤±è´¥ï¼š"+e1.message); console.error(e1); return; }

  // 2) ä¸Šä¼ å¤šå¼ æ”¶æ® + å†™å…¥ attachments
  if(files && files.length){
    for(const f of files){
      const filename = `${Date.now()}_${encodeURIComponent(f.name)}`;
      const path = `receipts/${claim.id}/${filename}`;
      const { error: eUp } = await supabase.storage.from('receipts').upload(path, f, { upsert:false });
      if(eUp){ setMsg("ä¸Šä¼ å¤±è´¥ï¼š"+eUp.message); console.error(eUp); return; }

      const { data: { publicUrl } } = supabase.storage.from('receipts').getPublicUrl(path);
      const { error: eAtt } = await supabase.from('attachments').insert({ claim_id: claim.id, file_url: publicUrl, type:'receipt' });
      if(eAtt){ setMsg("ä¿å­˜æ”¶æ®è®°å½•å¤±è´¥ï¼š"+eAtt.message); console.error(eAtt); return; }
    }
  }

  setMsg("æäº¤æˆåŠŸï¼å³å°†è¿”å›åˆ—è¡¨â€¦", true);
  setTimeout(()=> location.href="/index.html", 800);
}

(async function(){ await checkLogin(); })();
</script>
</body>
</html>
