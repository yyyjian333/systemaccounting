<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>新增账单（可多张收据）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:720px;margin:24px auto;padding:0 16px;}
    h1{font-size:20px;margin:0 0 16px}
    .card{border:1px solid #eee;border-radius:10px;padding:16px;background:#fafafa}
    label{display:block;margin:10px 0 6px}
    input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    button{margin-top:14px;padding:10px 14px;border:0;border-radius:8px;background:#111;color:#fff;font-size:14px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .tip{margin:10px 0;color:#666}
    .nav{margin-bottom:14px}
    .nav a{margin-right:12px}
    .progress{font-size:12px;color:#666}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav"><a href="/">← 返回列表</a></div>
  <h1>📝 新增账单（可多张收据）</h1>
  <div class="card">
    <div class="tip">带星号的是必填项。收据可一次选择多张（图片或 PDF，单文件 ≤ 10MB）。</div>
    <form id="f">
      <label>提交人姓名 *</label>
      <input id="name" required placeholder="例如：Alice" />

      <label>金额（MYR） *</label>
      <input id="amount" required type="number" step="0.01" min="0" placeholder="例如：120.50" />

      <label>用途（买了啥/用在哪里） *</label>
      <textarea id="purpose" required rows="2" placeholder="例如：买打印纸"></textarea>

      <label>银行 *</label>
      <input id="bank" required placeholder="例如：Maybank" />

      <label>账户号 *</label>
      <input id="acct" required placeholder="例如：112-345-6789" />

      <label>收据（图片或 PDF，可多选）</label>
      <input id="receipts" type="file" accept="image/*,application/pdf" multiple />

      <button id="btn" type="submit">提交账单</button>
      <div id="msg" class="tip"></div>
      <div id="prog" class="progress"></div>
    </form>
  </div>

  <script>
    // 🔧 替换为你的项目配置
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('f');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const prog = document.getElementById('prog');
    const filesInput = document.getElementById('receipts');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true; msg.textContent = '提交中…'; prog.textContent = '';

      const payload = {
        submitter_name: document.getElementById('name').value.trim(),
        amount: Number(document.getElementById('amount').value),
        purpose: document.getElementById('purpose').value.trim(),
        bank_name: document.getElementById('bank').value.trim(),
        account_no: document.getElementById('acct').value.trim(),
        status: '已提交'
      };

      if (!payload.submitter_name || !payload.amount || !payload.purpose || !payload.bank_name || !payload.account_no) {
        msg.textContent = '请把带星号的内容填完整。';
        btn.disabled = false; return;
      }

      // 1) 插入 claims
      const { data: inserted, error: insErr } = await supabase
        .from('claims')
        .insert(payload)
        .select('id')
        .single();

      if (insErr) {
        console.error(insErr);
        msg.textContent = '提交失败：' + insErr.message;
        btn.disabled = false; return;
      }
      const claimId = inserted.id;

      // 2) 多张收据逐个上传
      const files = Array.from(filesInput.files || []);
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        if (f.size > 10 * 1024 * 1024) { msg.textContent = `第 ${i+1} 个文件超过 10MB，已跳过`; continue; }

        prog.textContent = `正在上传第 ${i+1}/${files.length} 张…`;
        const path = `${claimId}/${Date.now()}-${i}-${f.name}`;

        // 上传到 receipts 桶
        const { error: upErr } = await supabase.storage.from('receipts').upload(path, f);
        if (upErr) { msg.textContent = '收据上传失败：' + upErr.message; btn.disabled = false; return; }

        // 公开 URL & 写入 attachments
        const { data: pub } = supabase.storage.from('receipts').getPublicUrl(path);
        const fileUrl = pub.publicUrl;

        const { error: attErr } = await supabase
          .from('attachments')
          .insert({ claim_id: claimId, file_url: fileUrl, type: 'receipt' });

        if (attErr) { msg.textContent = '附件记录失败：' + attErr.message; btn.disabled = false; return; }
      }

      msg.textContent = '提交成功！即将返回列表…';
      setTimeout(() => { window.location.href = '/'; }, 600);
    });
  </script>
</body>
</html>
