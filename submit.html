<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>新增报销 · RM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fbf7ee; --surface:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#d4a016; --primary-600:#b4840e; --primary-100:#fff4d1;
      --info:#1f5fa3; --info-600:#164a80;
      --success:#16a34a; --danger:#dc2626;
      --radius:12px; --radius-sm:10px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --shadow-sm:0 3px 10px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang SC","Microsoft Yahei","Noto Sans CJK SC",sans-serif;
      max-width:880px; margin:28px auto; padding:0 16px;
    }
    h1{font-size:22px;margin:0 0 14px;font-weight:700}
    .nav{margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:var(--radius-sm);padding:9px 14px;font-size:14px;cursor:pointer;transition:transform .08s,box-shadow .2s;box-shadow:var(--shadow-sm)}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-600)}
    .btn-info{background:var(--info);color:#fff}.btn-info:hover{background:var(--info-600)}
    .btn-ghost{background:#f3f4f6;color:#111}
    .who{font-size:12px;color:var(--muted);margin-left:8px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 18px 16px;box-shadow:var(--shadow)}
    .grid2{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:14px}
    .field{min-width:0}
    label{font-size:13px;color:#374151;margin-bottom:6px;display:block}
    input,textarea,select{
      width:100%; max-width:100%;
      padding:11px 12px; border:1px solid var(--border); border-radius:var(--radius-sm);
      font-size:14px; background:#fff; outline:none;
    }
    input:focus,textarea:focus,select:focus{box-shadow:0 0 0 4px rgba(212,160,22,.12)}
    textarea{resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .muted{color:var(--muted)}
    .ok{color:var(--success)} .err{color:var(--danger)}
    .filewrap{display:flex;align-items:center;gap:10px;padding:10px;border:1px dashed var(--border);border-radius:var(--radius-sm);background:#fff}
    .filewrap input[type="file"]{padding:6px;border:0;box-shadow:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="nav">
    <a class="btn btn-info" href="/index.html">← 返回列表</a>
    <a class="btn btn-ghost" href="#" onclick="logout()">🚪 登出</a>
    <span id="who" class="who"></span>
  </div>

  <h1>🧾 新增报销申请</h1>

  <div class="card">
    <div class="grid2">
      <div class="field">
        <label>申请人姓名 *</label>
        <input id="name" placeholder="例如：王小明" required />
      </div>
      <div class="field">
        <label>金额（MYR） *</label>
        <input id="amount" type="number" step="0.01" placeholder="例如：120.00" required />
      </div>

      <div class="field">
        <label>报销用途 *</label>
        <textarea id="purpose" rows="3" placeholder="例如：购买办公用品、出差住宿费等"></textarea>
      </div>
      <div class="field">
        <label>收款银行 *</label>
        <input id="bank" placeholder="Maybank / CIMB…" />
        <div class="hint">员工本人想收款的银行</div>
      </div>

      <div class="field">
        <label>收款账户号 *</label>
        <input id="account" placeholder="例如：112-345-6789" />
      </div>
      <div class="field">
        <label>收据附件（可多选）</label>
        <div class="filewrap">
          <input id="files" type="file" multiple accept="image/*,.pdf" />
          <div class="muted" id="fileHint">未选择任何文件</div>
        </div>
        <div class="hint">支持 JPG、PNG、PDF，每个 ≤10MB</div>
      </div>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px">
      <button class="btn btn-primary" onclick="submitClaim()">提交报销</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function checkLogin(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ alert("请先登录"); location.href="/login.html"; return; }
  document.getElementById('who').textContent = session.user.email;
}
async function logout(){ await supabase.auth.signOut(); location.href="/login.html"; }

const fileInput = document.getElementById('files');
const fileHint  = document.getElementById('fileHint');
fileInput?.addEventListener('change', () => {
  const n = fileInput.files?.length || 0;
  fileHint.textContent = n ? `已选择 ${n} 个文件` : '未选择任何文件';
});

function setMsg(text, ok=false){
  const el=document.getElementById('msg');
  el.textContent=text;
  el.className = ok ? 'ok' : (text ? 'err' : 'muted');
}

async function submitClaim(){
  setMsg("正在提交…", true);
  const submitter_name = document.getElementById('name').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const purpose = document.getElementById('purpose').value.trim();
  const bank_name = document.getElementById('bank').value.trim();
  const account_no = document.getElementById('account').value.trim();
  const files = document.getElementById('files').files;

  if(!submitter_name || !amount || !purpose || !bank_name || !account_no){
    setMsg("请把必填信息填写完整"); return;
  }

  // 1️⃣ 新建报销申请（状态：已提交）
  const { data: claim, error: e1 } = await supabase
    .from('claims')
    .insert({
      submitter_name,
      amount,
      purpose,
      bank_name,     // 员工自己的收款银行
      account_no,    // 员工自己的收款账户
      status:'已提交'
    })
    .select('id')
    .single();

  if(e1){ setMsg("创建报销失败："+e1.message); console.error(e1); return; }

  /// 2) 上传多张收据 + 写入 attachments
if (files && files.length) {
  for (const f of files) {
    // 生成“安全文件名”：只保留字母数字、下划线、横杠和点；空格等都变成 _
    const safeName = f.name
      .normalize('NFKD')            // 规范化避免特殊组合字符
      .replace(/[^\w.\-]+/g, '_');  // 非字母数字 . _ - 的都转成下划线

    const filename = `${Date.now()}_${safeName}`;
    const path = `receipts/${claim.id}/${filename}`;

    // 上传（加上 contentType）
    const { error: eUp } = await supabase
      .storage
      .from('receipts')
      .upload(path, f, { upsert: false, contentType: f.type });

    if (eUp) {
      // 如果某个文件失败，不要写入 attachments 记录
      console.error('上传失败', eUp, '文件=', f.name);
      setMsg("上传失败：" + eUp.message);
      continue;
    }

    // 如果 receipts bucket 是 Public，用 publicUrl；不是 Public 就用签名 URL
    const { data: { publicUrl } } = supabase.storage.from('receipts').getPublicUrl(path);

    const { error: eAtt } = await supabase
      .from('attachments')
      .insert({ claim_id: claim.id, file_url: publicUrl, type: 'receipt' });

    if (eAtt) {
      console.error('写入附件记录失败', eAtt);
      setMsg("保存收据记录失败：" + eAtt.message);
      continue;
    }
  }
}

  // 3️⃣ 完成提示
  setMsg("提交成功！即将返回列表…", true);
  setTimeout(()=> location.href="/index.html", 800);
}

(async function(){ await checkLogin(); })();
</script>
</body>
</html>
