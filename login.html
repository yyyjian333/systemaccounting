<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>登录 · RM 记账系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fbf7ee; --surface:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#d4a016; --primary-600:#b4840e; --primary-100:#fff4d1;
      --info:#1f5fa3; --info-600:#164a80; --info-100:#e8f2ff;
      --danger:#dc2626; --radius:14px; --shadow:0 12px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 75% -10%, rgba(212,160,22,.08), transparent 60%),
                  radial-gradient(900px 600px at -10% 110%, rgba(31,95,163,.08), transparent 60%),
                  var(--bg);
      color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang SC","Microsoft Yahei","Noto Sans CJK SC",sans-serif;
      padding:24px;
    }
    .card{
      width:100%; max-width:410px; background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:28px 26px;
    }
    .brand{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }

   
    .brand-logo{
      width:42px; height:42px; border-radius:10px; object-fit:contain;
      background:#fff; 
      box-shadow:0 6px 18px rgba(212,160,22,.15);
    }

 
    .logo{
      width:42px; height:42px; border-radius:10px;
      background: linear-gradient(135deg, var(--primary) 0%, #f2c64b 100%);
      display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800;
      box-shadow: 0 6px 18px rgba(212,160,22,.35);
    }

    h1{font-size:20px; margin:0}
    .sub{font-size:13px; color:var(--muted); margin:4px 0 18px}

    label{display:block; font-size:13px; color:#374151; margin:10px 0 6px}
    .input-wrap{position:relative}
    input{
      width:100%; padding:12px 44px 12px 12px; border:1px solid var(--border);
      border-radius:10px; font-size:14px; outline:none; background:#fff;
    }
    input:focus{box-shadow:0 0 0 4px rgba(212,160,22,.12)}

    .toggle{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      font-size:12px; color:var(--info-600); cursor:pointer; user-select:none;
    }

    .btn{
      width:100%; padding:12px; border:0; border-radius:10px; font-size:15px; cursor:pointer;
      background:var(--info); color:#fff; margin-top:12px;
      box-shadow:0 8px 18px rgba(31,95,163,.25); transition:.15s transform ease,.2s filter ease;
    }
    .btn:hover{filter:saturate(1.05)}
    .btn:active{transform:translateY(1px)}

    .links{display:flex; justify-content:space-between; gap:10px; margin-top:10px}
    .link{font-size:13px; color:var(--info-600); text-decoration:none}
    .link:hover{text-decoration:underline}

    .msg{margin-top:12px; font-size:13px; color:var(--danger); min-height:20px}
    .ok{color:#16a34a}
    .foot{margin-top:18px; text-align:center; font-size:12px; color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <div class="brand">
    
      <img id="brandLogo" class="brand-logo" src="/logo.png" alt="RM GROUP Logo"
           onerror="this.style.display='none'; document.getElementById('brandFallback').style.display='flex'">
      <div id="brandFallback" class="logo" style="display:none">RM</div>

      <div>
        <h1>RM 记账系统</h1>
        <div class="sub">请登录以继续</div>
      </div>
    </div>

    <label for="email">邮箱</label>
    <div class="input-wrap">
      <input id="email" type="email" placeholder="name@example.com" autocomplete="username" />
    </div>

    <label for="password">密码</label>
    <div class="input-wrap">
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
      <span id="toggle" class="toggle">显示</span>
    </div>

    <button class="btn" id="btnLogin">登录</button>

    <div class="links">
      <a class="link" href="#" id="linkReset">忘记密码？</a>
      <a class="link" href="/index.html">返回主页</a>
    </div>

    <div id="msg" class="msg"></div>
  </div>


  <div class="card" id="resetCard" style="display:none">
    <div class="brand">
      <img class="brand-logo" src="/logo.png" alt="RM GROUP Logo"
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
      <div class="logo" style="display:none">RM</div>
      <div>
        <h1>设置新密码</h1>
        <div class="sub">请输入您的新密码</div>
      </div>
    </div>

    <label for="newPassword">新密码</label>
    <div class="input-wrap">
      <input id="newPassword" type="password" placeholder="请输入新密码（至少6位）" autocomplete="new-password" />
      <span id="toggleNew" class="toggle">显示</span>
    </div>

    <label for="confirmPassword">确认密码</label>
    <div class="input-wrap">
      <input id="confirmPassword" type="password" placeholder="再次输入新密码" autocomplete="new-password" />
    </div>

    <button class="btn" id="btnSavePassword">保存新密码</button>

    <div id="resetMsg" class="msg"></div>
    <div class="foot">© RM GROUP</div>
  </div>

  <script>
    const SUPABASE_URL = "https://jdzytjocdkuzjtuwygdl.supabase.co";      
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkenl0am9jZGt1emp0dXd5Z2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjA2MjgsImV4cCI6MjA3NjE5NjYyOH0.jP-CwOVxYhfHXGOz_l_Q7Xc-umLIcJQH0_LJZSUAxNw";
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 


    let isRecoveryMode = false;

    (async () => {
   
      const hash = window.location.hash;
      if (hash && hash.includes('type=recovery')) {
        isRecoveryMode = true;
       
        document.querySelector('.card').style.display = 'none';
        $("resetCard").style.display = 'block';
        return;
      }

     
      const { data: { session } } = await supabase.auth.getSession();
      if (session) location.href = "/index.html";
    })();

    const $ = (id) => document.getElementById(id);
    const msg = $("msg");

    $("toggle").addEventListener("click", () => {
      const p = $("password");
      const on = p.type === "password";
      p.type = on ? "text" : "password";
      $("toggle").textContent = on ? "隐藏" : "显示";
    });

    $("btnLogin").addEventListener("click", login);
    $("password").addEventListener("keydown", e => (e.key === "Enter") && login());

    async function login(){
      const email = $("email").value.trim();
      const password = $("password").value.trim();
      if(!email || !password){ show("请填写邮箱和密码"); return; }

      show("正在登录…", true);
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { show("登录失败：" + error.message); return; }

      show("登录成功，正在跳转…", true);
      setTimeout(() => location.href = "/index.html", 400);
    }


    $("linkReset").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = $("email").value.trim();
      if(!email){ show("请输入邮箱后再点“忘记密码”。"); return; }
      show("正在发送重置邮件…", true);
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: location.origin + "/login.html"
      });
      if (error) show("发送失败：" + error.message);
      else show("已发送，请检查邮箱。", true);
    });

    function show(t, ok){ msg.textContent = t; msg.className = "msg" + (ok ? " ok" : ""); }
  </script>
</body>
</html>
